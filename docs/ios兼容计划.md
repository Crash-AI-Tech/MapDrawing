# iOS å…¼å®¹ä¸å¼€å‘æ–¹æ¡ˆè®¡åˆ’ (Expo ç‰ˆ) - v2.0

## 1. æ¶æ„æ¦‚è§ˆ (Monorepo)

å·²å®Œæˆæ¶æ„é‡æ„ï¼Œé‡‡ç”¨ Monorepo ç»“æ„ï¼š
- **`web/`**: Next.js å‰ç«¯ (å·²éªŒè¯)
- **`ios/`**: Expo Go / Development Build é¡¹ç›® (å¾…å¼€å‘)
- **`cf-workers/`**: åç«¯ API + WebSocket æœåŠ¡ (å¤ç”¨)
- **`drizzle/`**: æ•°æ®åº“ Schema (å…±äº«)

## 2. æ ¸å¿ƒæŠ€æœ¯é€‰å‹ï¼šç»˜å›¾å¼•æ“ (PencilKit vs Skia)

ç”¨æˆ·è¯¢é—®æ˜¯å¦èƒ½ä½¿ç”¨ `PencilKit`ã€‚ç»è¿‡åˆ†æï¼š
- **PencilKit**: Apple åŸç”Ÿæ¡†æ¶ï¼Œä½“éªŒæä½³ï¼Œä½† **æ•°æ®æ ¼å¼ç§æœ‰ (PKDrawing)**ï¼Œå¾ˆéš¾è§£æå‡ºæˆ‘ä»¬éœ€è¦çš„â€œåƒç´ ç‚¹â€æˆ–â€œçŸ¢é‡è·¯å¾„â€æ•°æ®æ¥å‘é€ç»™ WebSocketã€‚ä¸”æ— æ³•åœ¨ Android ä¸Šè¿è¡Œï¼ˆå¦‚æœæœªæ¥è€ƒè™‘ï¼‰ã€‚
- **React Native Skia (`@shopify/react-native-skia`)**: 
    - **é«˜æ€§èƒ½**: ç›´æ¥åœ¨ GPU ä¸Šç»˜åˆ¶ï¼Œæ€§èƒ½æ¥è¿‘åŸç”Ÿã€‚
    - **å¯æ§æ€§å¼º**: æˆ‘ä»¬å¯ä»¥å®Œå…¨æŒæ§æ¯ä¸€ä¸ªç¬”ç”»çš„åæ ‡ç‚¹ (Points)ï¼Œè¿™å¯¹äºæˆ‘ä»¬â€œåŸºäºåœ°ç†ä½ç½®çš„ç»˜å›¾â€ (Geo-Coordinate) è‡³å…³é‡è¦ã€‚
    - **è·¨å¹³å°**: iOS/Android è¡¨ç°ä¸€è‡´ã€‚
    - **ç°æœ‰å…¼å®¹**: Web ç«¯ä½¿ç”¨ Canvas 2Dï¼ŒSkia çš„ API ä¸ Canvas 2D éå¸¸ç›¸ä¼¼ï¼Œé€»è¾‘å¤ç”¨ç‡é«˜ã€‚

**ç»“è®º**: æ¨èç»§ç»­ä½¿ç”¨ **React Native Skia**ï¼Œé€šè¿‡æ‰‹åŠ¿å“åº”å™¨ (Gesture Handler) è·å–ç‚¹åæ ‡ï¼Œå®æ—¶æ¸²æŸ“ã€‚

## 3. æ•°æ®åº“ä¸ API æ”¹é€ 

ç›®å‰ `users` è¡¨ä»…æ”¯æŒ Email/Passwordã€‚ä¸ºæ”¯æŒ iOS App Store å®¡æ ¸è¦æ±‚çš„ **Sign in with Apple**ï¼Œéœ€è¦æ”¹é€ ï¼š

### 3.1 æ•°æ®åº“å˜æ›´ (`drizzle/schema.ts`)
éœ€å¢åŠ  OAuth å­—æ®µï¼š
```typescript
export const users = sqliteTable('users', {
  // ... existing fields
  appleId: text('apple_id').unique(), // å¯¹åº” Apple User Identity
  avatarUrl: text('avatar_url'),      // å­˜å‚¨å¤´åƒ
});
```

### 3.2 API æ¥å£ (Web ç«¯æ–°å¢)
iOS ç«¯æ— æ³•ç›´æ¥æ“ä½œ Cookieï¼Œéœ€å¼€å‘åŸºäº Token çš„ APIï¼š
- `POST /api/auth/mobile/login`: é‚®ç®±ç™»å½•ï¼Œè¿”å› `{ token, user }`
- `POST /api/auth/mobile/apple`: æ¥æ”¶ Apple Identity Tokenï¼ŒéªŒè¯å¹¶ç™»å½•/æ³¨å†Œï¼Œè¿”å› `{ token, user }`
- `GET /api/auth/mobile/me`: æ ¡éªŒ Token è·å–ç”¨æˆ·ä¿¡æ¯

## 4. iOS App äº¤äº’è®¾è®¡ (Canvas-First)

ç”±äº App æ²¡æœ‰ä¸»é¡µ (Landing Page)ï¼Œæ‰“å¼€å³ç”»å¸ƒï¼Œéœ€è®¾è®¡å¼•å¯¼æµç¨‹ï¼š

### 4.1 å¯åŠ¨æµç¨‹ (App Launch)
1.  **Splash Screen**: Logo å±•ç¤ºï¼ˆExpo é»˜è®¤ï¼‰ã€‚
2.  **æƒé™è¯·æ±‚**: 
    - **ä½ç½®æƒé™**: "æˆ‘ä»¬éœ€è¦æ‚¨çš„ä½ç½®æ¥åœ¨åœ°å›¾ä¸Šæ˜¾ç¤ºæ‚¨çš„ç”»ä½œã€‚" (å¿…é¡»ï¼Œå¦åˆ™æ— æ³•å®šä½)
    - **é€šçŸ¥æƒé™**: (å¯é€‰) "å½“æœ‰äººåœ¨æ‚¨é™„è¿‘ç»˜ç”»æ—¶é€šçŸ¥æ‚¨ã€‚"
3.  **Onboarding (é¦–æ¬¡æ‰“å¼€)**:
    - åŠé€æ˜é®ç½©è¦†ç›–åœ°å›¾ï¼Œç®€å•çš„ 3 æ­¥åŠ¨ç”»å¼•å¯¼ï¼š
        - "è¿™é‡Œæ˜¯ç”»å¸ƒ" (æŒ‡å‘åœ°å›¾)
        - "è¿™æ˜¯ç”»ç¬”" (æŒ‡å‘å·¥å…·æ )
        - "å¼€å§‹åˆ›ä½œï¼"
4.  **æœªç™»å½•çŠ¶æ€**:
    - å…è®¸**æ¸¸å®¢æµè§ˆ** (View Only)ã€‚
    - å½“ç”¨æˆ·ç‚¹å‡»â€œç”»ç¬”â€æˆ–â€œå‘å¸ƒâ€æ—¶ï¼Œå¼¹å‡º **ç™»å½•/æ³¨å†Œ Sheet (åŠå±å¼¹çª—)**ã€‚
    - æ”¯æŒ "Sign in with Apple" ä¸€é”®ç™»å½•ã€‚

### 4.2 æ ¸å¿ƒç•Œé¢å¸ƒå±€
- **åº•å›¾**: MapLibre GL Native (å…¨å±)ã€‚
- **ç»˜å›¾å±‚**: Skia Canvas (è¦†ç›–å…¨å±ï¼Œé€æ˜èƒŒæ™¯)ã€‚
- **é¡¶éƒ¨æ  (Floating)**:
    - å·¦ä¾§: ä¸ªäººå¤´åƒ (ç‚¹å‡»æ»‘å‡ºèœå•)ã€‚
    - ä¸­é—´: å½“å‰ä½ç½®/æˆ¿é—´ä¿¡æ¯ã€‚
    - å³ä¾§: æœç´¢/å®šä½æŒ‰é’®ã€‚
- **åº•éƒ¨æ  (Floating Tool Bar)**:
    - ç±»ä¼¼ Web ç«¯çš„æ‚¬æµ®èƒ¶å›Šè®¾è®¡ã€‚
    - åŒ…å«ï¼šç”»ç¬”é€‰æ‹©ã€é¢œè‰²é€‰æ‹©ã€æ’¤é”€/é‡åšã€‚
    - ç‚¹å‡»ç”»ç¬”å¼¹å‡ºè¯¦ç»†è®¾ç½®é¢æ¿ (BottomSheet)ã€‚

## 5. å¼€å‘ä»»åŠ¡æ‹†è§£

### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€è®¾æ–½ & è®¤è¯ (Day 1-2)
- [ ] **Schema æ›´æ–°**: æ·»åŠ  `appleId` å­—æ®µï¼Œè¿è¡Œ migrationã€‚
- [ ] **API å¼€å‘**: å®ç° `/api/auth/mobile/*` æ¥å£ã€‚
- [ ] **Expo åŸºç¡€**: é…ç½® TypeScript, Alias, import å…±äº«ä»£ç ã€‚
- [ ] **Auth å¹¶æ²¡æœ‰**: é›†æˆ `expo-apple-authentication` å’Œ `expo-secure-store`ã€‚

### ç¬¬äºŒé˜¶æ®µï¼šåœ°å›¾ä¸ç»˜å›¾ (Day 3-5)
- [ ] **åœ°å›¾é›†æˆ**: å¼•å…¥ `@maplibre/maplibre-react-native`ï¼ŒåŠ è½½è‡ªå®šä¹‰ Styleã€‚
- [ ] **å®šä½åŠŸèƒ½**: é›†æˆ `expo-location`ï¼Œå®ç°å®šä½è·³è½¬ã€‚
- [ ] **Skia ç”»æ¿**: å®ç°å…¨å±é€æ˜ Canvasï¼Œå¤„ç†æ‰‹åŠ¿ (PanGesture)ã€‚
- [ ] **ç¬”åˆ·é€»è¾‘**: å¤ç”¨ Web ç«¯çš„ç¬”åˆ·ç®—æ³• (Need to extract to `shared/`).

### ç¬¬ä¸‰é˜¶æ®µï¼šåŒæ­¥ä¸äº¤äº’ (Day 6-7)
- [ ] **WebSocket**: ç§»æ¤ `DurableObjectClient`ï¼Œé€‚é… Token è®¤è¯ã€‚
- [ ] **UI å®ç°**: ä½¿ç”¨ React Native Reanimated é‡å†™æ‚¬æµ®å·¥å…·æ ã€‚
- [ ] **æ€§èƒ½ä¼˜åŒ–**: ç¡®ä¿ 60fps ç»˜å›¾ä½“éªŒã€‚

---

**å†³ç­–ç‚¹**: æ˜¯å¦åŒæ„é‡‡ç”¨ Skia æ›¿ä»£ PencilKit ä»¥æ¢å–æ•°æ®æ§åˆ¶æƒå’Œè·¨å¹³å°ä¸€è‡´æ€§ï¼Ÿ(é»˜è®¤æ¨è Skia)

---

## 6. iOS ç«¯ç°çŠ¶é—®é¢˜åˆ†æä¸ä¸‹ä¸€æ­¥å…¼å®¹è®¡åˆ’ (v2.1)

> **æ—¥æœŸ**: 2026-02-12
> **é—®é¢˜æ¦‚è¿°**: iOS ç«¯åœ°å›¾çœ‹ä¸åˆ°è¡—é“/åœ°å;ç»˜åˆ¶çº¿æ¡æ•ˆæœä¸ Web ç«¯ä¸ä¸€è‡´;ç¼ºå¤±å¤§é‡æ ¸å¿ƒé€»è¾‘

### 6.1 é—®é¢˜ä¸€ï¼šåœ°å›¾ç“¦ç‰‡ â€” æ— è¡—é“å’Œåœ°åæ˜¾ç¤º

**æ ¹æœ¬åŸå› **: iOS ç«¯ä½¿ç”¨äº† MapLibre å®˜æ–¹ Demo Tilesï¼Œè€Œé Web ç«¯çš„ OpenFreeMap Liberty çŸ¢é‡ç“¦ç‰‡ã€‚

| ç«¯ | StyleURL | æ•ˆæœ |
|---|---|---|
| **Web** | `https://tiles.openfreemap.org/styles/liberty` | âœ… å®Œæ•´çš„ OSM çŸ¢é‡ç“¦ç‰‡ï¼ŒåŒ…å«è¡—é“ã€åœ°åã€å»ºç­‘ã€POI ç­‰å…¨éƒ¨æ ‡æ³¨ |
| **iOS** | `https://demotiles.maplibre.org/style.json` | âŒ ä»…åŒ…å«å›½ç•Œçº¿ã€æ°´åŸŸç­‰æç®€åŒ–å†…å®¹ï¼Œ**æ— ä»»ä½•è¡—é“å’Œåœ°å** |

**ä¿®å¤æ–¹æ¡ˆ**: å°† iOS ç«¯çš„ `styleURL` æ”¹ä¸º Web ç«¯åŒæ¬¾ï¼š

```tsx
// ios/app/(app)/index.tsx â€” ä¿®æ”¹å‰
styleURL="https://demotiles.maplibre.org/style.json"

// ä¿®æ”¹å â€” ä½¿ç”¨ OpenFreeMap Libertyï¼ˆä¸ Web å®Œå…¨ä¸€è‡´ï¼‰
styleURL="https://tiles.openfreemap.org/styles/liberty"
```

> **æ³¨æ„**: OpenFreeMap Liberty ç“¦ç‰‡å®Œå…¨å…è´¹ã€æ— éœ€ API Keyã€æ”¯æŒ MapLibre GL Nativeã€‚å¦‚é‡ä¸­å›½å¤§é™†ç½‘ç»œé—®é¢˜å¯è€ƒè™‘åœ¨ Cloudflare Workers æ­ä»£ç†ã€‚

**åŒæ—¶ä¿®æ­£ zoom é»˜è®¤å€¼**:
- iOS å½“å‰: `zoomLevel: 10` â€” å¤ªå°ï¼Œçœ‹ä¸åˆ°ç»†èŠ‚
- Web: `MAP_DEFAULT_ZOOM = 14` â€” é€‚åˆçœ‹åˆ°è¡—åŒºçº§åˆ«
- åº”ç»Ÿä¸€ä¸º `14` å¹¶ä» `@niubi/shared` å¼•å…¥

---

### 6.2 é—®é¢˜äºŒï¼šç»˜åˆ¶é€»è¾‘å·®å¼‚ â€” çº¿æ¡æ•ˆæœä¸ä¸€è‡´

ç»è¿‡é€è¡Œå¯¹æ¯” Web ç«¯ `core/brushes/` ä¸ iOS ç«¯ `getBrushSettings()`ï¼Œå‘ç°**iOS ç«¯çš„ç¬”åˆ·ç³»ç»Ÿæ˜¯æåº¦ç®€åŒ–çš„å ä½å®ç°**ï¼Œä¸ Web ç«¯å­˜åœ¨ä»¥ä¸‹æ ¸å¿ƒå·®å¼‚ï¼š

#### 6.2.1 é“…ç¬” (Pencil)

| ç‰¹æ€§ | Web ç«¯ (`PencilBrush.ts`) | iOS ç«¯ (å½“å‰) | å·®å¼‚ |
|---|---|---|---|
| æ›²çº¿ç®—æ³• | **äºŒæ¬¡è´å¡å°”æ›²çº¿** (`quadraticCurveTo`) é€šè¿‡ä¸­ç‚¹å¹³æ»‘ | `Skia.Path.lineTo()` ç›´çº¿æ®µæ‹¼æ¥ | âŒ iOS çº¿æ¡é”¯é½¿ä¸¥é‡ï¼Œæ‹è§’ç”Ÿç¡¬ |
| å‹åŠ›æ„Ÿåº” | âœ… `getWidth(size, pressure)` = `size * (0.5 + pressure * 0.5)` åŠ¨æ€çº¿å®½ | âŒ å›ºå®šçº¿å®½ï¼Œæ— å‹æ„Ÿ | âŒ ç¼ºå¤±å‹æ„Ÿå˜å®½æ•ˆæœ |
| æ¸²æŸ“æ–¹å¼ | Canvas2D `stroke()` é€æ®µç»˜åˆ¶ | Skia `<Path>` æ•´ä½“æ¸²æŸ“ | å¯æ¥å—ä½†éœ€åŠ å¹³æ»‘ |

#### 6.2.2 é©¬å…‹ç¬” (Marker)

| ç‰¹æ€§ | Web ç«¯ (`MarkerBrush.ts`) | iOS ç«¯ (å½“å‰) | å·®å¼‚ |
|---|---|---|---|
| ä¸å è‰²æŠ€æœ¯ | **OffscreenCanvas åŒç¼“å†²** â€” å…ˆåœ¨ç¦»å±ç”»å¸ƒä»¥ opacity=1 ç»˜åˆ¶ï¼Œå†ä»¥ `globalAlpha=0.3` åˆæˆåˆ°ä¸»ç”»å¸ƒ | ç›´æ¥è®¾ `opacity: 0.8`ï¼Œçº¿æ®µäº¤å‰å¤„**é¢œè‰²é‡å ** | âŒ æ ¸å¿ƒæ•ˆæœç¼ºå¤± |
| çº¿å®½ | `size * 3` | `size * 3` | âœ… ä¸€è‡´ |
| Opacity | 0.3 (åˆæˆ) | 0.8 (ç›´æ¥) | âŒ ä¸ä¸€è‡´ |

#### 6.2.3 è§å…‰ç¬” (Highlighter)

| ç‰¹æ€§ | Web ç«¯ (`HighlighterBrush.ts`) | iOS ç«¯ (å½“å‰) | å·®å¼‚ |
|---|---|---|---|
| æ··åˆæ¨¡å¼ | `globalCompositeOperation = 'multiply'` | `BlendMode.SrcOver`ï¼ˆæ™®é€šå åŠ ï¼‰ | âŒ æ—  multiply æ•ˆæœ |
| çº¿å¤´ | `square`ï¼ˆæ–¹å¤´ï¼‰ | `StrokeCap.Round`ï¼ˆåœ†å¤´ï¼‰ | âŒ å¤–è§‚ä¸ä¸€è‡´ |
| çº¿å®½ | `size * 2.5` | `size * 8` | âŒ iOS åç²— 3.2 å€ |
| Opacity | 0.4 (å›ºå®š) | 0.4 | âœ… ä¸€è‡´ |

#### 6.2.4 å–·æª (Spray)

| ç‰¹æ€§ | Web ç«¯ (`SprayBrush.ts`) | iOS ç«¯ (å½“å‰) | å·®å¼‚ |
|---|---|---|---|
| æ¸²æŸ“æ–¹å¼ | **éšæœºç²’å­æ•£ç‚¹** â€” é«˜æ–¯è¡°å‡å¯†åº¦ï¼Œ30 ç²’å­/å¸§ | ç®€å•ç²—çº¿æ¡ (`lineTo`) | âŒ å®Œå…¨ä¸åŒçš„è§†è§‰æ•ˆæœ |
| ç¡®å®šæ€§å›æ”¾ | âœ… åŸºäº stroke.id å“ˆå¸Œçš„ç¡®å®šæ€§éšæœºç§å­ | âŒ æ—  | âŒ æ— æ³•å¤ç°ç›¸åŒæ•ˆæœ |

#### 6.2.5 é€šç”¨ç¼ºå¤±

| ç¼ºå¤±é¡¹ | è¯´æ˜ | å½±å“ |
|---|---|---|
| **åœ°ç†åæ ‡è½¬æ¢** | iOS ä»…ä½¿ç”¨å±å¹•åƒç´ åæ ‡ `(g.x, g.y)` ç»˜å›¾ï¼Œ**æœªæŠ•å½±åˆ°ç»çº¬åº¦** | âŒ åœ°å›¾ç§»åŠ¨/ç¼©æ”¾åï¼Œçº¿æ¡ä¸ä¼šè·Ÿéšåœ°å›¾ï¼Œæ— æ³•æŒä¹…åŒ– |
| **ç¼©æ”¾è·Ÿéš (Zoom Scaling)** | Web ç«¯å†å²ç¬”ç”»ä»¥ `size * 2^(currentZoom - createdZoom)` ç¼©æ”¾ | âŒ iOS çº¿æ¡å¤§å°å›ºå®šï¼Œä¸éšç¼©æ”¾å˜åŒ– |
| **ç¬”ç”»æ˜¾éšè§„åˆ™** | Web ç«¯ `currentZoom >= createdZoom - 3` å¦åˆ™éšè— | âŒ iOS å…¨éƒ¨æ˜¾ç¤º |
| **MIN_DRAW_ZOOM é—¨æ§** | Web ç«¯ zoom < 18 ç¦æ­¢ç»˜ç”» | âŒ iOS ä»»æ„ zoom å¯ç”» |
| **Redo** | Web ç«¯åŒæ ˆ Undo/Redo (max 100) | âŒ iOS ä»…æœ‰ Undo (æ•°ç»„è£å‰ª) |
| **å¢¨æ°´ç³»ç»Ÿ** | é¢ç§¯ Ã— ç¼©æ”¾çš„ ink cost å…¬å¼ | âŒ æœªæ¥å…¥ |
| **ç¬”ç”»å¤§å° Slider** | Web ç«¯å·¥å…·æ æœ‰å¤§å°/é€æ˜åº¦è°ƒèŠ‚ | âŒ iOS å·¥å…·æ æ— æ­¤ UI |

---

### 6.3 ä¸‹ä¸€æ­¥å…¼å®¹è®¡åˆ’ (iOS Sprint Plan)

> ç›®æ ‡: ä½¿ iOS ç«¯çš„åœ°å›¾æ˜¾ç¤ºã€ç»˜åˆ¶æ•ˆæœã€åæ ‡ç³»ç»Ÿä¸ Web ç«¯å®Œå…¨å¯¹é½

#### ç¬¬é›¶é˜¶æ®µï¼šå³æ—¶ä¿®å¤ (Day 0 â€” 30 åˆ†é’Ÿ)

- [ ] **P0-1**: ä¿®æ”¹ `styleURL` â†’ `https://tiles.openfreemap.org/styles/liberty`
- [ ] **P0-2**: ä¿®æ”¹é»˜è®¤ `zoomLevel` â†’ `MAP_DEFAULT_ZOOM (14)` ï¼Œä» `@niubi/shared` å¯¼å…¥
- [ ] **P0-3**: ä¿®æ”¹åœ°å›¾äº¤äº’ï¼šdraw æ¨¡å¼ä¸‹ä»å¯åŒæŒ‡ç¼©æ”¾/å¹³ç§»åœ°å›¾ (åç»­æ‰‹åŠ¿å†²çªå¤„ç†)

#### ç¬¬ä¸€é˜¶æ®µï¼šåæ ‡ç³»ç»Ÿå¯¹é½ (Day 1 â€” æ ¸å¿ƒ)

è¿™æ˜¯**æœ€å…³é”®**çš„ä¸€æ­¥ã€‚ä¸è§£å†³åæ ‡é—®é¢˜ï¼Œæ‰€æœ‰ç»˜åˆ¶æ•°æ®éƒ½æ— æ³•æŒä¹…åŒ–å’Œè·¨ç«¯åŒæ­¥ã€‚

- [ ] **P1-1**: åˆ›å»º `MapLibreNativeAdapter` (å®ç° `CoordinateConverter` æ¥å£)
  - `screenToGeo(screenX, screenY)` â†’ è°ƒç”¨ MapLibre React Native çš„ `getCoordinateFromView([x, y])` 
  - `geoToScreen(lng, lat)` â†’ è°ƒç”¨ `getPointInView([lng, lat])`
  - `getViewportBounds()` â†’ è°ƒç”¨ `getVisibleBounds()`
  - `getViewState()` â†’ è·å– center, zoom, bearing, pitch
  
  ```typescript
  // ios/platform/MapLibreNativeAdapter.ts (æ–°å»º)
  import MapLibreGL from '@maplibre/maplibre-react-native';
  import type { CoordinateConverter, ViewState, GeoBounds } from '@niubi/shared/types';
  
  export class MapLibreNativeAdapter implements CoordinateConverter {
    private mapRef: MapLibreGL.MapView;
    
    async screenToGeo(screenX: number, screenY: number) {
      const coord = await this.mapRef.getCoordinateFromView([screenX, screenY]);
      return { lng: coord[0], lat: coord[1] };
    }
    
    async geoToScreen(lng: number, lat: number) {
      const point = await this.mapRef.getPointInView([lng, lat]);
      return { x: point[0], y: point[1] };
    }
    // ...
  }
  ```

  > **å…³é”®å·®å¼‚**: MapLibre React Native çš„åæ ‡è½¬æ¢ API æ˜¯ **å¼‚æ­¥** çš„ (éœ€è¦è·¨ Native Bridge)ï¼Œè€Œ Web ç«¯æ˜¯åŒæ­¥çš„ã€‚éœ€è¦è®¾è®¡å¼‚æ­¥é€‚é…æ–¹æ¡ˆã€‚

- [ ] **P1-2**: ä¿®æ”¹æ‰‹åŠ¿ `onEnd` â€” å°†å±å¹•åæ ‡è½¬æ¢ä¸ºç»çº¬åº¦åå­˜å…¥ `StrokeData.points`
- [ ] **P1-3**: å®ç°æ¸²æŸ“æ—¶çš„ geoâ†’screen åå‘æŠ•å½± â€” åœ°å›¾ç§»åŠ¨/ç¼©æ”¾æ—¶é‡æ–°æ¸²æŸ“æ‰€æœ‰å¯è§ç¬”ç”»
- [ ] **P1-4**: å¼•å…¥ `StrokeData` ç±»å‹ (from `@niubi/shared`) ç»Ÿä¸€ç¬”ç”»æ•°æ®æ¨¡å‹

#### ç¬¬äºŒé˜¶æ®µï¼šç¬”åˆ·æ•ˆæœå¯¹é½ (Day 2-3)

ä½¿ç”¨ Skia API å¤åˆ» Web ç«¯ Canvas2D çš„ç¬”åˆ·æ•ˆæœï¼š

- [ ] **P2-1**: **é“…ç¬” â€” è´å¡å°”å¹³æ»‘**
  - å°† `path.lineTo()` æ›¿æ¢ä¸º `path.quadTo()` (Skia çš„äºŒæ¬¡è´å¡å°”)
  - ç®—æ³•: å–æœ€å 3 ä¸ªç‚¹ï¼Œè®¡ç®—ä¸­ç‚¹ï¼Œ`quadTo(controlX, controlY, endX, endY)`
  - ä¼˜å…ˆçº§: ğŸ”´ é«˜ (ç›´æ¥å½±å“çº¿æ¡è´¨æ„Ÿ)
  
  ```typescript
  // Skia è´å¡å°”å¹³æ»‘ç¤ºä¾‹
  if (points.length >= 3) {
    const prev = points[points.length - 3];
    const ctrl = points[points.length - 2]; 
    const curr = points[points.length - 1];
    const midX1 = (prev.x + ctrl.x) / 2;
    const midY1 = (prev.y + ctrl.y) / 2;
    const midX2 = (ctrl.x + curr.x) / 2;
    const midY2 = (ctrl.y + curr.y) / 2;
    path.moveTo(midX1, midY1);
    path.quadTo(ctrl.x, ctrl.y, midX2, midY2);
  }
  ```

- [ ] **P2-2**: **é“…ç¬” â€” å‹åŠ›æ„Ÿåº”å˜å®½**
  - æ–¹æ¡ˆ A: å°†ä¸€æ¡è¿ç»­ Path æ‹†åˆ†ä¸ºé€æ®µç‹¬ç«‹ Pathï¼Œæ¯æ®µç”¨ä¸åŒ `strokeWidth`
  - æ–¹æ¡ˆ B: ä½¿ç”¨ Skia çš„ `PathEffect` æˆ–å°† stroke è½¬ä¸º fill (å˜å®½çš„è´å¡å°”å¸¦)
  - æ¨èæ–¹æ¡ˆ Aï¼Œå®ç°ç®€å•ä¸”è§†è§‰å·®å¼‚å¯æ¥å—

- [ ] **P2-3**: **é©¬å…‹ç¬” â€” ä¸å è‰²**
  - ä½¿ç”¨ Skia çš„ `<Group layer={...}>` é…åˆ `SaveLayerRec` å®ç°:
    1. åœ¨ä¸€ä¸ªç‹¬ç«‹å›¾å±‚ (layer) ä¸­ä»¥ `opacity=1.0` ç»˜åˆ¶å®Œæ•´ç¬”ç”»
    2. æ•´ä¸ªå›¾å±‚ä»¥ `opacity=0.3` åˆæˆåˆ°ç”»å¸ƒ
  - æˆ–è€…ä½¿ç”¨ `Paint` çš„ `setAlphaf()` + `Skia.SaveLayerFlag`
  
  ```tsx
  // Skia é©¬å…‹ç¬”ä¸å è‰²æ–¹æ¡ˆ
  <Group layer={
    <Paint opacity={0.3} />
  }>
    <Path path={markerPath} color={color} style="stroke" 
          strokeWidth={size * 3} opacity={1.0} />
  </Group>
  ```

- [ ] **P2-4**: **è§å…‰ç¬” â€” Multiply æ··åˆæ¨¡å¼**
  - Skia æ”¯æŒ `BlendMode.Multiply`ï¼Œç›´æ¥æ›¿æ¢ `BlendMode.SrcOver`
  - çº¿å¤´æ”¹ä¸º `StrokeCap.Butt` (å¯¹åº” Web çš„ `square`)
  - çº¿å®½ä¿®æ­£: `size * 2.5` (å½“å‰æ˜¯ `size * 8`ï¼Œè¿‡ç²—)

- [ ] **P2-5**: **å–·æª â€” ç²’å­æ•£ç‚¹**
  - ä½¿ç”¨ Skia `<Points>` æˆ– `<Circle>` é€ç²’å­æ¸²æŸ“
  - å®ç°é«˜æ–¯å¯†åº¦è¡°å‡: è·ä¸­å¿ƒè¶Šè¿œ â†’ alpha è¶Šä½
  - ç¡®å®šæ€§å›æ”¾: ä» stroke.id è®¡ç®— hash â†’ ä½œä¸º PRNG ç§å­
  
  ```typescript
  // Skia å–·æªç²’å­æ¸²æŸ“
  const DENSITY = 30;
  for (const point of stroke.points) {
    const count = Math.floor(DENSITY * point.pressure);
    for (let i = 0; i < count; i++) {
      const angle = seededRandom() * Math.PI * 2;
      const r = seededRandom() * radius;
      const alpha = (1 - r / radius) * 0.6;
      // ä½¿ç”¨ Skia canvas.drawCircle() æˆ–æ‰¹é‡ Points
    }
  }
  ```

#### ç¬¬ä¸‰é˜¶æ®µï¼šæ¸²æŸ“ç®¡çº¿å¯¹é½ (Day 3-4)

- [ ] **P3-1**: å®ç° **åŒå±‚ Canvas æ¶æ„**
  - å±‚ 1 (compositeLayer): æ¸²æŸ“æ‰€æœ‰å·²å®Œæˆçš„å†å²ç¬”ç”» (geoâ†’screen å˜æ¢å)
  - å±‚ 2 (activeLayer): æ¸²æŸ“å½“å‰æ­£åœ¨ç»˜åˆ¶çš„å®æ—¶ç¬”ç”»
  - ä½¿ç”¨ Skia `<Canvas>` åµŒå¥—æˆ– `<Picture>` ç¼“å­˜æœºåˆ¶

- [ ] **P3-2**: å®ç° **zoom-scale ç¬”ç”»å¤§å°**
  - å†å²ç¬”ç”»æ¸²æŸ“æ—¶: `screenSize = storedSize * 2^(currentZoom - createdZoom)`
  - ç¡®ä¿æ”¾å¤§çœ‹åˆ°ç²—çº¿ï¼Œç¼©å°çœ‹åˆ°ç»†çº¿

- [ ] **P3-3**: å®ç° **ç¬”ç”»æ˜¾éšè§„åˆ™**
  - `currentZoom >= stroke.createdZoom - STROKE_HIDE_ZOOM_DIFF (3)` â†’ æ˜¾ç¤º
  - å¦åˆ™ â†’ ä¸æ¸²æŸ“

- [ ] **P3-4**: å®ç° **MIN_DRAW_ZOOM é—¨æ§**
  - å½“ `zoom < 18` æ—¶ç¦æ­¢ç»˜ç”»
  - æ˜¾ç¤ºæç¤º: "è¯·æ”¾å¤§åˆ° 18 çº§ä»¥ä¸Šæ‰èƒ½ç»˜ç”»"

- [ ] **P3-5**: ç›‘å¬åœ°å›¾ **move/zoom äº‹ä»¶** â†’ è§¦å‘é‡æ–°æ¸²æŸ“
  - åœ°å›¾è§†å£å˜åŒ–æ—¶ï¼Œæ‰€æœ‰å†å²ç¬”ç”»éœ€è¦é‡æ–° geoâ†’screen è½¬æ¢å¹¶é‡ç»˜
  - ä½¿ç”¨ `onRegionDidChange` å›è°ƒ

#### ç¬¬å››é˜¶æ®µï¼šæ‰‹åŠ¿ç³»ç»Ÿä¼˜åŒ– (Day 4-5)

- [ ] **P4-1**: **ç»˜ç”»ä¸åœ°å›¾æ‰‹åŠ¿å…±å­˜**
  - å½“å‰å®ç°: draw æ¨¡å¼ä¸‹å®Œå…¨ç¦æ­¢åœ°å›¾äº¤äº’ â†’ ä½“éªŒå·®
  - ç›®æ ‡: å•æŒ‡ç”»ç”»ã€åŒæŒ‡ç¼©æ”¾å¹³ç§» (ä¸ Web ç«¯ä¸€è‡´)
  - æ–¹æ¡ˆ: ä½¿ç”¨ `Gesture.Simultaneous()` / `Gesture.Race()` + `GestureRecognizer` é€»è¾‘
    - 1 finger â†’ draw
    - 2 fingers â†’ å–æ¶ˆå½“å‰ç¬”ç”» â†’ ä¼ é€’ç»™åœ°å›¾åš pinch-zoom/pan
    - 3 fingers â†’ undo

- [ ] **P4-2**: **PressureAdapter** ç§»æ¤
  - Apple Pencil: ç›´æ¥è¯»å– `nativeEvent.force`
  - æ‰‹æŒ‡è§¦æ‘¸: æœ‰ force ç”¨ forceï¼Œå¦åˆ™åŸºäºé€Ÿåº¦æ¨¡æ‹Ÿ
  - è®¡ç®—æ–¹å¼: `pressure = clamp(1 - velocity / 3, 0.1, 1)` (Web ç«¯åŒæ¬¾)

#### ç¬¬äº”é˜¶æ®µï¼šå¼•æ“ç§»æ¤ (Day 5-7)

å°† Web ç«¯ `core/engine/` çš„çº¯ TS é€»è¾‘ç§»æ¤åˆ°å…±äº«åŒ…æˆ–ç›´æ¥å¤ç”¨ï¼š

- [ ] **P5-1**: ç§»æ¤ `InkManager` â†’ iOS æ¥å…¥é¢ç§¯å¢¨æ°´æ¶ˆè€—å…¬å¼
  - ä½¿ç”¨ `@react-native-async-storage/async-storage` æ›¿ä»£ `localStorage` åšæŒä¹…åŒ–
- [ ] **P5-2**: ç§»æ¤ `HistoryManager` â†’ åŒæ ˆ Undo/Redo (max 100)
- [ ] **P5-3**: ç§»æ¤ `StrokeManager` + R-tree ç©ºé—´ç´¢å¼• (`rbush` åŒ… React Native å¯ç”¨)
- [ ] **P5-4**: ç§»æ¤ `ViewportManager` â†’ å¯¹æ¥ `MapLibreNativeAdapter`
- [ ] **P5-5**: æ•´åˆ `DrawingEngine` â†’ ç”¨ Skia çš„æ¸²æŸ“æ–¹æ³•æ›¿ä»£ Canvas2D è°ƒç”¨

> **è¿ç§»ç­–ç•¥**: ç”±äº `core/engine/` å’Œ `core/types/` ä¸ºçº¯ TypeScriptã€é›¶ Web DOM ä¾èµ–ï¼Œå¯è€ƒè™‘å°†å…¶æå–åˆ° `packages/shared/` ä¸­ï¼ŒiOS å’Œ Web ç›´æ¥å¤ç”¨ç›¸åŒå¼•æ“é€»è¾‘ï¼Œä»…åœ¨æ¸²æŸ“å±‚ (`brushes/` + `renderer/`) åšå¹³å°é€‚é…ã€‚

#### ç¬¬å…­é˜¶æ®µï¼šå·¥å…·æ å¢å¼º + åŒæ­¥ (Day 7-9)

- [ ] **P6-1**: å·¥å…·æ å¢åŠ  **ç¬”ç”»å¤§å° Slider** (ä½¿ç”¨ `@react-native-community/slider` æˆ– `react-native-reanimated` è‡ªå®šä¹‰)
- [ ] **P6-2**: å·¥å…·æ å¢åŠ  **é€æ˜åº¦ Slider**
- [ ] **P6-3**: å¢åŠ  **Redo æŒ‰é’®**
- [ ] **P6-4**: å¢åŠ  **å¢¨æ°´æ¡ (InkBar)** â€” æ¸å˜è‰² + æ•°å€¼æ˜¾ç¤º
- [ ] **P6-5**: WebSocket åŒæ­¥ â€” ç§»æ¤ `DurableObjectClient`ï¼Œä½¿ç”¨ Token è®¤è¯ (æ›¿ä»£ Cookie)
- [ ] **P6-6**: REST API åŠ è½½ â€” è§†å£å˜åŒ–æ—¶ `GET /api/drawings` æ‰¹é‡åŠ è½½ç¬”ç”»
- [ ] **P6-7**: Pin å›¾é’‰ç³»ç»Ÿ â€” å®ç°æ”¾ç½®ã€æ¸²æŸ“ã€æ¶ˆæ¯å±•ç¤º

---

### 6.4 å…³é”®æŠ€æœ¯éš¾ç‚¹ä¸å¯¹ç­–

| éš¾ç‚¹ | æè¿° | å¯¹ç­– |
|---|---|---|
| **Native Bridge å¼‚æ­¥åæ ‡è½¬æ¢** | MapLibre RN çš„ `getCoordinateFromView()` æ˜¯å¼‚æ­¥çš„ï¼Œè€Œ Web æ˜¯åŒæ­¥ | æ–¹æ¡ˆ 1: åœ¨ `onUpdate` ä¸­ç¼“å­˜æœ€è¿‘çš„ viewState + è‡ªè¡Œè®¡ç®—ç»çº¬åº¦ (ç”¨ Web Mercator å…¬å¼ï¼Œä¸è¿‡ bridge)ï¼›æ–¹æ¡ˆ 2: ä½¿ç”¨ `MapLibre.Camera.onUserTrackingModeChange` / `getCenter` ç¼“å­˜æŠ•å½±å‚æ•°åæœ¬åœ°è®¡ç®— |
| **Skia æ—  OffscreenCanvas** | é©¬å…‹ç¬”åŒç¼“å†²éœ€è¦é¢å¤–ç”»å¸ƒ | ä½¿ç”¨ Skia `<Group layer>` + `Paint` çš„ layer æœºåˆ¶å®ç°ç­‰æ•ˆæ•ˆæœ |
| **è¿è¡Œåœ¨ JS çº¿ç¨‹ vs Worklet** | å½“å‰ `runOnJS(true)`ï¼Œé«˜é¢‘è§¦æ§å¯èƒ½å¡é¡¿ | æœªæ¥è¿ç§»åˆ° Worklet çº¿ç¨‹: `gesture.onUpdate(worklet)` + `useSharedValue` è¿›è¡Œ Skia path æ“ä½œï¼Œç¡®ä¿ 60fps |
| **R-tree åœ¨ RN ä¸­çš„å…¼å®¹æ€§** | `rbush` æœ¬èº«çº¯ JSï¼Œå¯ç›´æ¥ç”¨ï¼›ä½†å¤§é‡ç¬”ç”»æ—¶å†…å­˜éœ€æ³¨æ„ | ç›´æ¥å¤ç”¨ `rbush`ï¼Œé…åˆè§†å£è£å‰ªé™åˆ¶å†…å­˜ç¬”ç”»æ•° â‰¤ 5000 |
| **Skia multiply æ··åˆæ¨¡å¼** | `BlendMode.Multiply` åœ¨ Skia ä¸­æ˜¯é€åƒç´ æ··åˆï¼Œéœ€è¦åº•å±‚æœ‰å†…å®¹ | å¦‚æœ¬èº«åœ¨é€æ˜å±‚ä¸Š multiply æ•ˆæœä¸æ˜æ˜¾ï¼Œå¯æ”¹ä¸º `ColorBurn` æˆ–é™ä½ alpha + `SrcOver` è¿‘ä¼¼ |

---

### 6.5 ä¼˜å…ˆçº§æ€»ç»“

```
 ç´§æ€¥åº¦
  â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  â”‚ P0: styleURL +   â”‚  â† ç«‹å³ä¿®å¤ï¼ˆ30 minï¼‰
  â”‚  â”‚     zoomLevel    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚           â–¼
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  â”‚ P1: åæ ‡ç³»ç»Ÿ    â”‚  â† æ ¸å¿ƒåŸºç¡€ï¼Œé˜»å¡åç»­æ‰€æœ‰åŠŸèƒ½
  â”‚  â”‚  (Native Adapter)â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚           â–¼
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  â”‚ P2: ç¬”åˆ·æ•ˆæœ    â”‚  â† è§†è§‰ä¸€è‡´æ€§
  â”‚  â”‚  (è´å¡å°”/ä¸å è‰²) â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚           â–¼
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  â”‚ P3: æ¸²æŸ“ç®¡çº¿    â”‚  â† ç¼©æ”¾/æ˜¾éšè§„åˆ™
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚           â–¼
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  â”‚ P4: æ‰‹åŠ¿ç³»ç»Ÿ    â”‚  â† äº¤äº’ä½“éªŒ
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚           â–¼
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  â”‚ P5: å¼•æ“ç§»æ¤    â”‚  â† æ•°æ®æŒä¹…åŒ–å’Œå…¬å¹³æœºåˆ¶
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚           â–¼
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  â”‚ P6: UI + åŒæ­¥    â”‚  â† åŠŸèƒ½å®Œæ•´æ€§
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ æ—¶é—´
```

> **é¢„è®¡æ€»å·¥æœŸ**: 7~9 å¤© (ä¸€äººå…¨èŒ)ã€‚P0+P1 å®Œæˆåå³å¯å®ç°"çº¿æ¡è·Ÿéšåœ°å›¾"çš„åŸºæœ¬æ•ˆæœ;P2 å®Œæˆåè§†è§‰ä¸€è‡´æ€§æå‡ 80%;P3-P6 ä¸ºæ¸è¿›å¢å¼ºã€‚
