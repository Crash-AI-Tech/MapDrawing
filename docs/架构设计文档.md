# 架构设计文档

## 1. 用户旅程
- 用户进入单页面应用，看到项目简介与邮箱/密码登录模块。
- 新用户选择“注册”，填写邮箱与密码后收到 Supabase 验证邮件；完成邮箱验证后账号生效。
- 已验证用户使用邮箱 + 密码登录，进入留言板页面执行增删改查。
- 用户可随时点击“退出登录”回到未登录状态，或在确认后执行账号注销并清理个人留言。

## 2. 页面结构与导航
- **顶部导航**：显示项目标题以及当前邮箱与“退出登录”“删除账号”按钮。
- **主页区块**：展示项目简介、主要功能摘要、快速引导。
- **留言板区块**：留言列表 + 提交框，支持加载中与错误状态提示。
  - 未登录显示引导文案；登录后显示快速刷新、编辑、删除操作。

## 3. 前端模块分工
- `App`：负责导航、全局登录状态与退出/注销逻辑。
- `AuthPanel`：提供邮箱注册（发送验证邮件）与邮箱+密码登录入口。
- `MessageBoard`：管理留言列表获取、刷新、提交、编辑、删除。

## 4. Supabase 数据与接口
- **表设计**
	- `messages`：`id` (uuid)、`author_id` (uuid, referencing auth.users)、`content` (text)、`created_at`、`updated_at`。
- **认证**：使用 Supabase Auth 的邮箱+密码模式；注册时触发邮箱验证，登录成功后前端监听 `onAuthStateChange` 同步会话。
- **数据访问**：前端通过 `@supabase/supabase-js` 直接对 `messages` 表执行增删改查。
- **安全策略**：
	- RLS 限制：所有用户可读取全部留言；仅 `auth.uid() = author_id` 的用户可以插入、更新、删除自身留言。
	- 触发器 `set_updated_at` 维护更新时间，触发器 `set_message_owner` 确保插入时自动填充 `author_id = auth.uid()`。
	- 提供 `delete_current_user()` 安全包裹函数，支持用户自助删除账号并级联清理消息数据，同时使用 `security definer` 删除 `auth.users` 中的记录。

## 5. 环境与部署约定
- **环境变量**：`VITE_SUPABASE_URL`、`VITE_SUPABASE_ANON_KEY`；如需在 CLI 中操作，可额外配置 `SUPABASE_URL`、`SUPABASE_SERVICE_ROLE_KEY`。
- **本地开发**：使用 `.env.local` 管理密钥；`npm run dev` 启动前端即可。
- **部署**：推荐使用 Cloudflare Pages 或 Netlify，推送 `main` 触发构建；在平台上配置 Supabase 环境变量。
- **后续扩展**：若需要更多业务（如支付、统计），再引入额外的 Edge Functions 或后端服务。

