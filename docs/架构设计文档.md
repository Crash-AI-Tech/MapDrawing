# Map æ¶æ„è®¾è®¡æ–‡æ¡£

> **ç‰ˆæœ¬**: v6.0 â€” OpenNext è¿ç§»ç‰ˆ
> **æ—¥æœŸ**: 2025-07-26
> **æ ¸å¿ƒç›®æ ‡**: é«˜æ€§èƒ½åœ°å›¾ç»˜ç”»ã€å¤šç¬”åˆ·æ”¯æŒã€é¢ç§¯å¢¨æ°´ç³»ç»Ÿã€åœ–é‡˜ç•™è¨€ã€å…¨é‡å†å²ä¿ç•™
> **æŠ€æœ¯åŸºåº§**: TypeScript + Next.js 16 (App Router) + MapLibre GL + **Cloudflare (D1 + R2 + DO + OpenNext + Workers)**

---

## ä¸€ã€ç³»ç»Ÿæ¦‚è¿°

Map æ˜¯ä¸€ä¸ªã€Œåœ¨çœŸå®åœ°å›¾ä¸Šç”»ç”»ã€çš„å…¨çƒåä½œå¹³å°ã€‚ç”¨æˆ·å¯ä»¥ï¼š

- ğŸ¨ åœ¨ MapLibre GL åœ°å›¾ä¸Šä½¿ç”¨å››ç§ç”»ç¬”ï¼ˆé“…ç¬”/é©¬å…‹ç¬”/å–·æª/è§å…‰ç¬”ï¼‰è¿›è¡Œæ¶‚é¸¦
- ğŸ“Œ åœ¨åœ°å›¾ä¸Šæ”¾ç½®å½©è‰²å›¾é’‰ï¼Œç•™ä¸‹ 50 å­—ä»¥å†…çš„çŸ­æ¶ˆæ¯
- ğŸŒ æ‰€æœ‰åˆ›ä½œå®æ—¶åŒæ­¥ï¼Œè·¯è¿‡å…¶ä»–åŸå¸‚æ—¶èƒ½çœ‹åˆ°æ¥è‡ªä¸–ç•Œå„åœ°çš„æ¶‚é¸¦å’Œç•™è¨€
- ğŸ–¨ï¸ é¢ç§¯å¢¨æ°´ç³»ç»Ÿå…¬å¹³çº¦æŸæ¯ä¸ªç”¨æˆ·çš„ç»˜ç”»é‡

### è®¾è®¡åŸåˆ™

1. **å•ä¸€å¹³å°** â€” æ•°æ®åº“ã€å­˜å‚¨ã€è®¡ç®—ã€CDN å…¨éƒ¨åœ¨ Cloudflareï¼Œå†…ç½‘è®¿é—®ï¼Œé›¶è·¨å¢ƒå»¶è¿Ÿ
2. **å¼•æ“ä¸æ¡†æ¶è§£è€¦** â€” `src/core/` ä¸ºçº¯ TypeScriptï¼Œé›¶ React ä¾èµ–ï¼Œé€šè¿‡ hooks æ¡¥æ¥
3. **è¾¹ç¼˜ä¼˜å…ˆ** â€” Next.js è¿è¡Œäº Cloudflare Workers (via OpenNext + Assets)ï¼Œå…¨çƒ 300+ PoP å°±è¿‘å“åº”
4. **è‡ªå»ºè®¤è¯** â€” Lucia Auth v3 + D1ï¼Œå®Œå…¨æŒæ§ç”¨æˆ·æ•°æ®ï¼Œæ— ç¬¬ä¸‰æ–¹ä¾èµ–
5. **æ¸²æŸ“ç®¡çº¿åˆ†ç¦»** â€” MapLibre GLï¼ˆåœ°å›¾ï¼‰ä¸è‡ªå®šä¹‰ Canvas overlayï¼ˆç»˜ç”»ï¼‰å®Œå…¨ç‹¬ç«‹
6. **å…¬å¹³å¢¨æ°´** â€” é¢ç§¯ Ã— ç¼©æ”¾ç­‰çº§çš„å¢¨æ°´æ¶ˆè€—å…¬å¼ï¼Œé¼“åŠ±ç²¾ç»†ç»˜ç”»ï¼Œæƒ©ç½šå¤§é¢ç§¯è¦†ç›–

---

## äºŒã€æŠ€æœ¯æ ˆæ€»è§ˆ

| å±‚çº§ | æŠ€æœ¯é€‰å‹ | ç‰ˆæœ¬ | ç†ç”± |
|------|---------|------|------|
| **æ¡†æ¶** | Next.js (App Router) | 16.x | SSR/SSG + Cloudflare Workers (OpenNext) |
| **è¯­è¨€** | TypeScript (Strict) | 5.7+ | å…¨æ ˆç±»å‹å®‰å…¨ |
| **åœ°å›¾å¼•æ“** | MapLibre GL JS | 4.7+ | å¼€æº WebGL çŸ¢é‡ç“¦ç‰‡ï¼Œ60fps |
| **ç“¦ç‰‡æº** | OpenFreeMap Liberty | â€” | å…è´¹çŸ¢é‡ç“¦ç‰‡ï¼Œæ—  API Key |
| **ç»˜ç”»æ¸²æŸ“** | Canvas 2D overlay | â€” | ä¸‰å±‚ Canvas å åŠ åœ¨ MapLibre ä¹‹ä¸Š |
| **çŠ¶æ€ç®¡ç†** | Zustand | 5.x | è½»é‡ (~1KB)ï¼Œ5 ä¸ª store |
| **UI ç»„ä»¶** | shadcn/ui + Radix UI | â€” | Tooltip / Popover / Slider / Dialog |
| **CSS** | Tailwind CSS | 4.x | åŸå­åŒ– CSS |
| **è®¤è¯** | Lucia Auth + D1Adapter | 3.x | è‡ªå»ºè®¤è¯ï¼Œæ”¯æŒ SQLite é€‚é…å™¨ |
| **å¯†ç å“ˆå¸Œ** | PBKDF2 (Web Crypto) | â€” | Workers å…¼å®¹ï¼Œ100K è¿­ä»£ |
| **æ•°æ®åº“** | Cloudflare D1 (SQLite) | â€” | è¾¹ç¼˜ SQLiteï¼Œ5GB å…è´¹ |
| **å¯¹è±¡å­˜å‚¨** | Cloudflare R2 | â€” | S3 å…¼å®¹ï¼Œå¤´åƒä¸Šä¼  |
| **å®æ—¶åŒæ­¥** | Cloudflare Durable Objects | â€” | WebSocket æˆ¿é—´ï¼Œæ¯æˆ¿é—´ â‰¤500 è¿æ¥ |
| **æ¶ˆæ¯é˜Ÿåˆ—** | Cloudflare Queues | â€” | å¼‚æ­¥æ‰¹é‡ç¬”ç”»å†™å…¥ D1 |
| **ç¦»çº¿æ”¯æŒ** | idb-keyval (IndexedDB) | 6.x | æ–­ç½‘äº‹ä»¶é˜Ÿåˆ—ï¼Œé‡è¿è‡ªåŠ¨ flush |
| **ç©ºé—´ç´¢å¼•** | rbush (R-tree) | 4.x | å®¢æˆ·ç«¯ç¬”ç”»ç©ºé—´æŸ¥è¯¢ |
| **ID ç”Ÿæˆ** | uuid v7 | 11.x | æ—¶é—´æœ‰åº UUID |
| **å¼€å‘å·¥å…·** | wrangler + OpenNext | â€” | D1/R2/DO æœ¬åœ°æ¨¡æ‹Ÿ |

---

## ä¸‰ã€é¡¹ç›®ç›®å½•ç»“æ„ï¼ˆå®é™…ï¼‰

```
map/
â”œâ”€â”€ next.config.ts                  # Next.js é…ç½® (@cloudflare/next-on-pages)
â”œâ”€â”€ wrangler.toml                   # Cloudflare Pages ç»‘å®š (D1, R2, KV)
â”œâ”€â”€ tsconfig.json                   # TS strict + @cloudflare/workers-types
â”œâ”€â”€ postcss.config.mjs              # PostCSS + Tailwind
â”œâ”€â”€ package.json                    # v2.0.0, scripts: dev/build/deploy
â”œâ”€â”€ .env.example                    # ç¯å¢ƒå˜é‡æ¨¡æ¿
â”œâ”€â”€ .dev.vars                       # Wrangler æœ¬åœ° secrets (ä¸æäº¤)
â”‚
â”œâ”€â”€ public/                         # é™æ€èµ„æº (favicon)
â”‚
â”œâ”€â”€ docs/
â”‚   â””â”€â”€ æ¶æ„è®¾è®¡æ–‡æ¡£.md              # æœ¬æ–‡æ¡£
â”‚
â”œâ”€â”€ drizzle/                        # æ•°æ®åº“è¿ç§»
â”‚   â”œâ”€â”€ schema.ts                   # Drizzle ORM è¡¨ç»“æ„å®šä¹‰
â”‚   â””â”€â”€ migrations/
â”‚       â”œâ”€â”€ 0001_init.sql           # users + sessions + drawings
â”‚       â””â”€â”€ 0002_map_pins.sql       # map_pins
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ env.d.ts                    # CloudflareEnv ç±»å‹å£°æ˜
â”‚   â”œâ”€â”€ constants.ts                # å…¨å±€å¸¸é‡ (ç¬”åˆ·/é¢œè‰²/åœ°å›¾/å¢¨æ°´/åŒæ­¥)
â”‚   â”œâ”€â”€ middleware.ts               # Edge Middleware (Cookie æ£€æŸ¥)
â”‚   â”‚
â”‚   â”œâ”€â”€ app/                        # â˜… Next.js App Router
â”‚   â”‚   â”œâ”€â”€ layout.tsx              # Root Layout
â”‚   â”‚   â”œâ”€â”€ page.tsx                # é¦–é¡µ Landing Page (ä¸­è‹±åŒè¯­)
â”‚   â”‚   â”œâ”€â”€ globals.css             # Tailwind + shadcn ä¸»é¢˜ + MapLibre è¦†å†™
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ (auth)/                 # è®¤è¯è·¯ç”±ç»„
â”‚   â”‚   â”‚   â”œâ”€â”€ layout.tsx          # è®¤è¯é¡µé¢ Layout
â”‚   â”‚   â”‚   â”œâ”€â”€ login/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx        # ç™»å½•é¡µ
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ actions.ts      # ç™»å½• Server Action
â”‚   â”‚   â”‚   â”œâ”€â”€ register/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx        # æ³¨å†Œé¡µ
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ actions.ts      # æ³¨å†Œ Server Action
â”‚   â”‚   â”‚   â””â”€â”€ logout/
â”‚   â”‚   â”‚       â””â”€â”€ route.ts        # ç™»å‡º Route Handler
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ canvas/                 # â˜… æ ¸å¿ƒç”»å¸ƒé¡µ
â”‚   â”‚   â”‚   â”œâ”€â”€ layout.tsx          # Canvas Layout (Edge Runtime)
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx            # ç”»å¸ƒå…¥å£ (MapCanvas + Toolbar + AuthDialog)
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ api/                    # Route Handlers (Edge Runtime)
â”‚   â”‚       â”œâ”€â”€ drawings/
â”‚   â”‚       â”‚   â”œâ”€â”€ route.ts        # GET è§†å£æŸ¥è¯¢ / POST æ‰¹é‡å†™å…¥
â”‚   â”‚       â”‚   â””â”€â”€ [id]/route.ts   # GET / DELETE å•æ¡æ“ä½œ
â”‚   â”‚       â”œâ”€â”€ pins/
â”‚   â”‚       â”‚   â””â”€â”€ route.ts        # GET è§†å£æŸ¥è¯¢ / POST åˆ›å»ºå›¾é’‰
â”‚   â”‚       â”œâ”€â”€ profile/
â”‚   â”‚       â”‚   â””â”€â”€ route.ts        # GET / PATCH ç”¨æˆ·èµ„æ–™
â”‚   â”‚       â””â”€â”€ upload/
â”‚   â”‚           â””â”€â”€ route.ts        # POST R2 å¤´åƒä¸Šä¼  (2MB)
â”‚   â”‚
â”‚   â”œâ”€â”€ core/                       # â˜… æ¡†æ¶æ— å…³çš„ç»˜ç”»å¼•æ“ (çº¯ TS)
â”‚   â”‚   â”œâ”€â”€ engine/
â”‚   â”‚   â”‚   â”œâ”€â”€ DrawingEngine.ts    # å¼•æ“å…¥å£ï¼šç¬”ç”»ç”Ÿå‘½å‘¨æœŸ + å¢¨æ°´æ‰£è´¹
â”‚   â”‚   â”‚   â”œâ”€â”€ StrokeManager.ts    # ç¬”ç”»æ•°æ®ç®¡ç† (Map + R-tree ç©ºé—´ç´¢å¼•)
â”‚   â”‚   â”‚   â”œâ”€â”€ HistoryManager.ts   # Undo/Redo å‘½ä»¤æ ˆ (max 100)
â”‚   â”‚   â”‚   â”œâ”€â”€ ViewportManager.ts  # è§†å£çŠ¶æ€ + åæ ‡è½¬æ¢ä»£ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ InkManager.ts       # â˜… å¢¨æ°´ç³»ç»Ÿ (é¢ç§¯ Ã— ç¼©æ”¾å…¬å¼)
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ brushes/                # ç¬”åˆ·ç³»ç»Ÿ
â”‚   â”‚   â”‚   â”œâ”€â”€ BaseBrush.ts        # æŠ½è±¡åŸºç±»
â”‚   â”‚   â”‚   â”œâ”€â”€ BrushRegistry.ts    # ç¬”åˆ·æ³¨å†Œè¡¨
â”‚   â”‚   â”‚   â”œâ”€â”€ PencilBrush.ts      # é“…ç¬” (è´å¡å°”å¹³æ»‘ + å‹åŠ›å˜å®½)
â”‚   â”‚   â”‚   â”œâ”€â”€ MarkerBrush.ts      # é©¬å…‹ç¬” (åŒ pass ä¸å è‰²)
â”‚   â”‚   â”‚   â”œâ”€â”€ SprayBrush.ts       # å–·æª (é«˜æ–¯éšæœºç²’å­)
â”‚   â”‚   â”‚   â”œâ”€â”€ HighlighterBrush.ts # è§å…‰ç¬” (multiply æ··åˆ)
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ renderer/               # æ¸²æŸ“ç®¡çº¿
â”‚   â”‚   â”‚   â”œâ”€â”€ RenderPipeline.ts   # â˜… ä¸‰å±‚ Canvas æ¸²æŸ“å¾ªç¯ (rAF)
â”‚   â”‚   â”‚   â”œâ”€â”€ StrokeRenderer.ts   # ç¬”ç”»æ¸²æŸ“ (geoâ†’screen å˜æ¢)
â”‚   â”‚   â”‚   â”œâ”€â”€ TileCache.ts        # ä½å›¾ç“¦ç‰‡ç¼“å­˜ (é¢„ç•™ä¼˜åŒ–)
â”‚   â”‚   â”‚   â”œâ”€â”€ OverlayManager.ts   # Canvas å°ºå¯¸åŒæ­¥ + DPR ç®¡ç†
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ input/                  # è¾“å…¥æŠ½è±¡å±‚
â”‚   â”‚   â”‚   â”œâ”€â”€ InputManager.ts     # Pointer Events â†’ Engine è°ƒç”¨
â”‚   â”‚   â”‚   â”œâ”€â”€ GestureRecognizer.ts # æ‰‹åŠ¿è¯†åˆ« (ç»˜ç”»/å¹³ç§»/ç¼©æ”¾)
â”‚   â”‚   â”‚   â”œâ”€â”€ PressureAdapter.ts  # å‹åŠ›æ„Ÿåº”æ ‡å‡†åŒ–
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ sync/                   # åŒæ­¥å±‚
â”‚   â”‚   â”‚   â”œâ”€â”€ SyncManager.ts      # åŒæ­¥ç¼–æ’ (DO + REST + ç¦»çº¿é˜Ÿåˆ—)
â”‚   â”‚   â”‚   â”œâ”€â”€ DurableObjectClient.ts # WebSocket å®¢æˆ·ç«¯ (æŒ‡æ•°é€€é¿)
â”‚   â”‚   â”‚   â”œâ”€â”€ OfflineQueue.ts     # IndexedDB ç¦»çº¿äº‹ä»¶é˜Ÿåˆ—
â”‚   â”‚   â”‚   â”œâ”€â”€ EventStream.ts      # äº‹ä»¶åºåˆ—åŒ– + DB Row â†’ StrokeData
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ types/                  # æ ¸å¿ƒç±»å‹å®šä¹‰
â”‚   â”‚       â”œâ”€â”€ stroke.ts           # StrokeData, StrokePoint, GeoBounds
â”‚   â”‚       â”œâ”€â”€ events.ts           # DrawEvent, SyncMessage, SyncState
â”‚   â”‚       â”œâ”€â”€ viewport.ts         # ViewState, CoordinateConverter
â”‚   â”‚       â””â”€â”€ index.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ platform/                   # å¹³å°é€‚é…å±‚
â”‚   â”‚   â””â”€â”€ web/
â”‚   â”‚       â”œâ”€â”€ MapLibreAdapter.ts  # CoordinateConverter å®ç° (MapLibre GL)
â”‚   â”‚       â”œâ”€â”€ WebCanvasProvider.ts # ä¸¤å±‚ Canvas DOM åˆ›å»º + é¼ æ ‡æŒ‡é’ˆ
â”‚   â”‚       â””â”€â”€ index.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ hooks/                      # React Hooks (å¼•æ“ â†” React æ¡¥æ¥)
â”‚   â”‚   â”œâ”€â”€ useDrawingEngine.ts     # åˆå§‹åŒ–å®Œæ•´ç»˜ç”»ç®¡çº¿
â”‚   â”‚   â”œâ”€â”€ useAuth.ts              # è·å–ç™»å½•ç”¨æˆ· + èµ„æ–™
â”‚   â”‚   â”œâ”€â”€ useSync.ts              # SyncManager ç”Ÿå‘½å‘¨æœŸ
â”‚   â”‚   â”œâ”€â”€ useToolbar.ts           # Toolbar UI â†” Store æ¡¥æ¥
â”‚   â”‚   â”œâ”€â”€ useViewport.ts          # è§†å£å˜åŒ– â†’ åŠ è½½ç¬”ç”»/å›¾é’‰
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ stores/                     # Zustand çŠ¶æ€ç®¡ç† (5 ä¸ª store)
â”‚   â”‚   â”œâ”€â”€ authStore.ts            # ç”¨æˆ· + Profile
â”‚   â”‚   â”œâ”€â”€ drawingStore.ts         # ç”»ç¬”/é¢œè‰²/å¤§å°/æ’¤é”€/é‡åš
â”‚   â”‚   â”œâ”€â”€ inkStore.ts             # å¢¨æ°´å€¼ + ä½å¢¨æ°´è­¦å‘Š
â”‚   â”‚   â”œâ”€â”€ pinStore.ts             # å›¾é’‰åˆ—è¡¨ + æ”¾ç½®çŠ¶æ€
â”‚   â”‚   â””â”€â”€ uiStore.ts              # åŒæ­¥çŠ¶æ€/ç¼©æ”¾çº§åˆ«/toast
â”‚   â”‚
â”‚   â”œâ”€â”€ components/                 # React ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ ui/                     # shadcn/ui åŸºç¡€ç»„ä»¶ (8 ä¸ª)
â”‚   â”‚   â”‚   â”œâ”€â”€ button.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ dialog.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ dropdown-menu.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ input.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ label.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ popover.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ slider.tsx
â”‚   â”‚   â”‚   â””â”€â”€ tooltip.tsx
â”‚   â”‚   â”œâ”€â”€ canvas/
â”‚   â”‚   â”‚   â””â”€â”€ MapCanvas.tsx       # â˜… æ ¸å¿ƒç»„ä»¶ (MapLibre + ç»˜ç”» + å›¾é’‰)
â”‚   â”‚   â”œâ”€â”€ toolbar/
â”‚   â”‚   â”‚   â”œâ”€â”€ Toolbar.tsx         # é¡¶éƒ¨æ°´å¹³å·¥å…·æ 
â”‚   â”‚   â”‚   â”œâ”€â”€ BrushPanel.tsx      # ç¬”åˆ·é¢æ¿ (ç±»å‹ + å¤§å° + é€æ˜åº¦)
â”‚   â”‚   â”‚   â”œâ”€â”€ ColorPicker.tsx     # é¢œè‰²é€‰æ‹©å™¨ (54è‰² + è‡ªå®šä¹‰)
â”‚   â”‚   â”‚   â””â”€â”€ InkBar.tsx          # å¢¨æ°´æ¡ (æ¸å˜è‰² + æ•°å€¼)
â”‚   â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”‚   â”œâ”€â”€ AuthDialog.tsx      # ç”»å¸ƒå†…ç™»å½•/æ³¨å†Œå¼¹çª—
â”‚   â”‚   â”‚   â”œâ”€â”€ LoginForm.tsx       # ç™»å½•è¡¨å• (useActionState)
â”‚   â”‚   â”‚   â”œâ”€â”€ RegisterForm.tsx    # æ³¨å†Œè¡¨å•
â”‚   â”‚   â”‚   â””â”€â”€ UserMenu.tsx        # ç”¨æˆ·å¤´åƒ/ä¸‹æ‹‰èœå•
â”‚   â”‚   â”œâ”€â”€ pins/
â”‚   â”‚   â”‚   â””â”€â”€ PinPlacer.tsx       # å›¾é’‰æ”¾ç½®é¢æ¿ (æ¶ˆæ¯ + é¢œè‰²é€‰æ‹©)
â”‚   â”‚   â””â”€â”€ shared/
â”‚   â”‚       â”œâ”€â”€ ErrorBoundary.tsx   # React é”™è¯¯è¾¹ç•Œ
â”‚   â”‚       â””â”€â”€ LoadingOverlay.tsx  # å…¨å±åŠ è½½åŠ¨ç”»
â”‚   â”‚
â”‚   â””â”€â”€ lib/                        # å·¥å…·å‡½æ•° & æœåŠ¡å°è£…
â”‚       â”œâ”€â”€ auth/
â”‚       â”‚   â”œâ”€â”€ lucia.ts            # Lucia å®ä¾‹ (D1Adapter)
â”‚       â”‚   â”œâ”€â”€ password.ts         # PBKDF2 å“ˆå¸Œ (Edge Runtime å…¼å®¹)
â”‚       â”‚   â””â”€â”€ session.ts          # Session éªŒè¯ (Server / Route Handler)
â”‚       â”œâ”€â”€ cloudflare/
â”‚       â”‚   â””â”€â”€ bindings.ts         # getEnv() / getDB() / getBucket() å°è£…
â”‚       â”œâ”€â”€ db/
â”‚       â”‚   â”œâ”€â”€ client.ts           # Drizzle ORM å®¢æˆ·ç«¯ + raw D1
â”‚       â”‚   â””â”€â”€ queries.ts          # ç¬”ç”»/ç”¨æˆ· CRUD æŸ¥è¯¢å°è£…
â”‚       â”œâ”€â”€ storage/
â”‚       â”‚   â””â”€â”€ r2.ts               # R2 ä¸Šä¼ /ä¸‹è½½/åˆ é™¤å°è£…
â”‚       â””â”€â”€ utils/
â”‚           â”œâ”€â”€ cn.ts               # clsx + tailwind-merge
â”‚           â””â”€â”€ geo.ts              # haversine è·ç¦» + bounds å·¥å…·
â”‚
â””â”€â”€ cf-workers/                     # â˜… Cloudflare Workers ç‹¬ç«‹é¡¹ç›®
    â”œâ”€â”€ wrangler.toml               # DO + Queue é…ç½®
    â”œâ”€â”€ package.json
    â”œâ”€â”€ tsconfig.json
    â””â”€â”€ src/
        â”œâ”€â”€ index.ts                # Worker å…¥å£ (è·¯ç”± + CORS + Queue æ¶ˆè´¹)
        â”œâ”€â”€ DrawingRoom.ts          # Durable Object: WebSocket æˆ¿é—´
        â””â”€â”€ BatchWriter.ts          # Queue Consumer: æ‰¹é‡ D1 å†™å…¥
```

---

## å››ã€ç³»ç»Ÿæ¶æ„å…¨æ™¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ç”¨æˆ·æµè§ˆå™¨                                 â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Server Layer     â”‚  â”‚       Client Layer                 â”‚   â”‚
â”‚  â”‚  (Edge Runtime)   â”‚  â”‚                                    â”‚   â”‚
â”‚  â”‚                   â”‚  â”‚  Drawing Engine (Core)              â”‚   â”‚
â”‚  â”‚  Server Actions   â”‚  â”‚   â”œâ”€ BrushRegistry                â”‚   â”‚
â”‚  â”‚  (login/register) â”‚  â”‚   â”œâ”€ StrokeManager (R-tree)       â”‚   â”‚
â”‚  â”‚  API Routes       â”‚  â”‚   â”œâ”€ InkManager (é¢ç§¯å…¬å¼)         â”‚   â”‚
â”‚  â”‚  (drawings/pins)  â”‚  â”‚   â”œâ”€ HistoryManager               â”‚   â”‚
â”‚  â”‚  validateSession() â”‚  â”‚   â””â”€ ViewportManager              â”‚   â”‚
â”‚  â”‚                   â”‚  â”‚                                    â”‚   â”‚
â”‚  â”‚  Lucia Auth v3    â”‚  â”‚  RenderPipeline (3-layer Canvas)   â”‚   â”‚
â”‚  â”‚  (D1 + PBKDF2)   â”‚  â”‚  Zustand Stores Ã—5                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                        â”‚                       â”‚
       â–¼                        â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cloudflare D1â”‚   â”‚  cf-workers (DO)  â”‚   â”‚ Cloudflare R2    â”‚
â”‚  (SQLite)    â”‚   â”‚  DrawingRoom (WS) â”‚   â”‚  (å¯¹è±¡å­˜å‚¨)       â”‚
â”‚              â”‚   â”‚   å¹¿æ’­/é€Ÿç‡é™åˆ¶     â”‚   â”‚  avatars/        â”‚
â”‚  users       â”‚   â”‚   å¿ƒè·³/ç©ºé—²é©±é€    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  sessions    â”‚â—€â”€â”€â”‚                   â”‚
â”‚  drawings    â”‚   â”‚  BatchWriter      â”‚
â”‚  map_pins    â”‚   â”‚   (Queueâ†’D1)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµ

```
ç»˜ç”»ç¬”ç”»:
  PointerEvent â†’ InputManager â†’ DrawingEngine.moveStroke()
    â”œâ”€ InkManager.calculateSegmentCost() â†’ æ‰£å‡å¢¨æ°´
    â”œâ”€ Brush.onStrokeMove() â†’ ç»˜åˆ¶åˆ° activeCanvas
    â””â”€ endStroke() â†’ StrokeManager.add() + HistoryManager.push()
         â”œâ”€ SyncManager.broadcastStroke()
         â”‚    â”œâ”€ POST /api/drawings â†’ D1 æŒä¹…åŒ–
         â”‚    â””â”€ DurableObjectClient.send() â†’ WebSocket å¹¿æ’­
         â””â”€ RenderPipeline.requestRender() â†’ rAF åˆæˆåˆ° compositeCanvas

å›¾é’‰æ”¾ç½®:
  MapClick â†’ PinPlacer UI â†’ POST /api/pins â†’ D1 å†™å…¥

è®¤è¯:
  Server Action â†’ D1 æŸ¥è¯¢ â†’ Lucia createSession â†’ Set-Cookie
```

---

## äº”ã€Drawing Engine æ ¸å¿ƒè®¾è®¡

### 5.1 å¼•æ“ä¸æ¡†æ¶å®Œå…¨è§£è€¦

`src/core/` ç›®å½•ä¸‹çš„æ‰€æœ‰ä»£ç ä¸º**çº¯ TypeScript**ï¼Œé›¶ React / Next.js ä¾èµ–ã€‚é€šè¿‡ä»¥ä¸‹æ¡¥æ¥å±‚è¿æ¥ï¼š

```
   React ä¸–ç•Œ                         çº¯ TS ä¸–ç•Œ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ useDrawingEngine â”‚â”€â”€initWithMapâ”€â”‚  DrawingEngine   â”‚
â”‚ (hooks)          â”‚              â”‚  StrokeManager   â”‚
â”‚                  â”‚              â”‚  InkManager      â”‚
â”‚ Zustand stores   â”‚â—€â”€â”€eventsâ”€â”€â”€â”‚  HistoryManager  â”‚
â”‚ (drawingStore,   â”‚              â”‚  ViewportManager â”‚
â”‚  inkStore, etc.) â”‚              â”‚  RenderPipeline  â”‚
â”‚                  â”‚              â”‚  InputManager    â”‚
â”‚                  â”‚â”€â”€subscribeâ”€â–¶â”‚  BrushRegistry   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

`useDrawingEngine` hook åœ¨ MapLibre åœ°å›¾åŠ è½½å®Œæˆåï¼š

1. åˆ›å»º `DrawingEngine` å®ä¾‹
2. åˆ›å»º `MapLibreAdapter` æ¡¥æ¥åæ ‡è½¬æ¢
3. åˆ›å»º `WebCanvasProvider` å åŠ ä¸¤å±‚ Canvas åˆ°åœ°å›¾ä¸Š
4. åˆ›å»º `RenderPipeline` å¹¶å¯åŠ¨ rAF æ¸²æŸ“å¾ªç¯
5. åˆ›å»º `InputManager` ç›‘å¬ Pointer Events
6. è®¢é˜…å¼•æ“äº‹ä»¶ â†’ æ›´æ–° Zustand stores

### 5.2 ç¬”ç”»æ•°æ®æ¨¡å‹

```typescript
interface StrokePoint {
  x: number;           // ç»åº¦ (å­˜å‚¨æ—¶) / å±å¹• X (ç»˜åˆ¶æ—¶)
  y: number;           // çº¬åº¦ (å­˜å‚¨æ—¶) / å±å¹• Y (ç»˜åˆ¶æ—¶)
  pressure: number;    // [0, 1]
  timestamp: number;   // ms
}

interface StrokeData {
  id: string;                // UUID v7 (æ—¶é—´æœ‰åº)
  userId: string;
  userName: string;
  brushId: string;           // pencil | marker | spray | highlighter
  color: string;             // #RRGGBB
  opacity: number;           // [0, 1]
  size: number;              // åŸºå‡†å°ºå¯¸ (CSS px)
  points: StrokePoint[];     // å­˜å‚¨æ—¶ä¸º geo åæ ‡ (lng, lat)
  bounds: GeoBounds;         // ç©ºé—´åŒ…å›´ç›’
  createdZoom: number;       // åˆ›å»ºæ—¶çš„ç¼©æ”¾çº§åˆ«
  createdAt: number;         // Unix ms
}
```

### 5.3 ç¬”ç”»ç”Ÿå‘½å‘¨æœŸ

```
startStroke(screenX, screenY, pressure)
  â†’ canDraw() æ£€æŸ¥å¢¨æ°´ â†’ åˆ›å»º UUID v7 â†’ Brush.onStrokeStart()

moveStroke(screenX, screenY, pressure)  (æ¯ä¸ª PointerMove)
  â†’ è®¡ç®— pixelDistance â†’ calculateSegmentCost() â†’ ç´¯åŠ  inkAccumulator
  â†’ æ•´æ•°éƒ¨åˆ†æ‰£å‡å¢¨æ°´ â†’ Brush.onStrokeMove()
  â†’ å¢¨æ°´è€—å°½è‡ªåŠ¨ endStroke()

endStroke()
  â†’ æ‰£å‡å‰©ä½™åˆ†æ•°å¢¨æ°´ â†’ è®¡ç®— GeoBounds â†’ å±å¹•åæ ‡è½¬æ¢ä¸ºç»çº¬åº¦
  â†’ StrokeManager.add() â†’ HistoryManager.push() â†’ emit stroke:end
```

### 5.4 ç¬”åˆ·æ¶æ„

å››ç§ç¬”åˆ·å‡ç»§æ‰¿ `BaseBrush` æŠ½è±¡ç±»ï¼Œé€šè¿‡ `BrushRegistry` ç®¡ç†ï¼š

| ç¬”åˆ· | ID | æ¸²æŸ“æŠ€æœ¯ | ç‰¹æ®Šæ•ˆæœ |
|------|-------|---------|---------|
| é“…ç¬” | `pencil` | `quadraticCurveTo` è´å¡å°”æ›²çº¿ | å‹åŠ›æ„Ÿåº”å˜å®½ |
| é©¬å…‹ç¬” | `marker` | OffscreenCanvas åŒ pass æŠ€æœ¯ | åŒç¬”ç”»ä¸å è‰² |
| å–·æª | `spray` | åŠå¾„å†…éšæœºç²’å­æ•£ç‚¹ | é«˜æ–¯è¡°å‡å¯†åº¦ï¼Œç¡®å®šæ€§å›æ”¾ |
| è§å…‰ç¬” | `highlighter` | `globalCompositeOperation='multiply'` | å›ºå®š opacity=0.4 |

æ‰©å±•ç¬”åˆ·åªéœ€ `extends BaseBrush` + `registry.register()`ã€‚

### 5.5 æ¸²æŸ“ç®¡çº¿ï¼ˆä¸‰å±‚ Canvasï¼‰

```
MapLibre GL (WebGL çŸ¢é‡åœ°å›¾)
         â”‚
         â”‚  å åŠ 
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  compositeCanvas                â”‚  â† RenderPipeline.render() æ¯å¸§åˆæˆ
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  å†å²ç¬”ç”» (ç›´æ¥æ¸²æŸ“)      â”‚   â”‚  â† StrokeRenderer éå†å¯è§ç¬”ç”»
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  + activeCanvas (å½“å‰ç¬”ç”»)       â”‚  â† drawImage() å åŠ å®æ—¶ç»˜åˆ¶å±‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ¸²æŸ“é€»è¾‘ï¼ˆæ¯å¸§ rAFï¼‰ï¼š**

1. æ¸…ç©º compositeCanvas
2. ä» StrokeManager æŸ¥è¯¢è§†å£å†…ç¬”ç”» (R-tree ç©ºé—´æŸ¥è¯¢)
3. è¿‡æ»¤ï¼š`currentZoom >= stroke.createdZoom - 3` (ç¼©æ”¾éšè—è§„åˆ™)
4. æŒ‰ `createdAt` å‡åºæ’åˆ—ï¼ˆæ–°ç¬”ç”»åœ¨ä¸Šå±‚ï¼‰
5. å¯¹æ¯ä¸ªç¬”ç”»è°ƒç”¨ `Brush.renderFullStroke()`ï¼Œä¼ å…¥ geoâ†’screen å˜æ¢
6. ä»¥ `storedSize * 2^(currentZoom - createdZoom)` è®¡ç®—å±å¹•åƒç´ å¤§å°
7. å åŠ  activeCanvasï¼ˆå½“å‰æ­£åœ¨ç»˜åˆ¶çš„ç¬”ç”»ï¼‰

### 5.6 ç¼©æ”¾ä¸ç¬”ç”»æ˜¾ç¤ºè§„åˆ™

| è§„åˆ™ | å®ç° |
|------|------|
| æœ€ä½ç»˜ç”»ç¼©æ”¾ | zoom >= 18 æ‰èƒ½ç”» (`MIN_DRAW_ZOOM`) |
| æœ€ä½å›¾é’‰ç¼©æ”¾ | zoom >= 20 æ‰èƒ½æ”¾ (`MIN_PIN_ZOOM`) |
| ç¬”ç”»éšè— | zoom < stroke.createdZoom - 3 æ—¶éšè— |
| ç¬”ç”»ç¼©æ”¾ | `screenSize = storedSize * 2^(currentZoom - createdZoom)` |

---

## å…­ã€å¢¨æ°´ç³»ç»Ÿè®¾è®¡

### 6.1 æ¦‚è¿°

å¢¨æ°´ç³»ç»Ÿæ˜¯ Map çš„æ ¸å¿ƒå…¬å¹³æœºåˆ¶ã€‚æ¯ä¸ªç”¨æˆ·æ‹¥æœ‰ 100 ç‚¹å¢¨æ°´ï¼Œç»˜ç”»æ¶ˆè€—å¢¨æ°´ï¼Œå¢¨æ°´éšæ—¶é—´æ¢å¤ã€‚

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|------|------|
| æœ€å¤§å¢¨æ°´ | 100 | MAX_INK |
| æ¢å¤é€Ÿåº¦ | +1 / 18ç§’ | REGEN_INTERVAL_MS = 18000 |
| å¹³è¡¡å¸¸æ•° K | 20 | INK_COST_K |
| åŸºå‡†ç¼©æ”¾ | 18 | ZOOM_BASE |
| å›¾é’‰æ¶ˆè€— | 50 | PIN_INK_COST |

### 6.2 å¢¨æ°´æ¶ˆè€—å…¬å¼

```
segmentCost = brushSize * pixelDistance * 2^(2 * (18 - zoom)) / K
```

- `brushSize` â€” å½“å‰ç”»ç¬”å¤§å° (1~10)
- `pixelDistance` â€” å½“å‰çº¿æ®µçš„å±å¹•åƒç´ é•¿åº¦
- `zoom` â€” å½“å‰åœ°å›¾ç¼©æ”¾çº§åˆ«
- `K = 20` â€” å¹³è¡¡å¸¸æ•°ï¼ˆè°ƒå¤§ = æ›´ä¾¿å®œï¼Œè°ƒå° = æ›´è´µï¼‰

**å…³é”®è®¾è®¡ï¼šzoom æ¯é™ä½ä¸€çº§ï¼Œæ¶ˆè€— x4ï¼ˆäºŒæ¬¡æ–¹ç¼©æ”¾ï¼‰**

è¿™æ„å‘³ç€ï¼š
- åœ¨ zoom 18 ç”»ä¸€ç¬” 100px (size=3) â†’ æ¶ˆè€— `3*100/20 = 15` å¢¨æ°´
- åœ¨ zoom 19 ç”»åŒæ ·ä¸€ç¬” â†’ æ¶ˆè€— `3*100*0.25/20 = 3.75` å¢¨æ°´
- åœ¨ zoom 20 ç”»åŒæ ·ä¸€ç¬” â†’ æ¶ˆè€— `3*100*0.0625/20 = 0.9375` å¢¨æ°´

**æ•ˆæœï¼šé¼“åŠ±ç²¾ç»†ç»˜ç”»ï¼ˆé«˜ zoom + å°ç¬”ï¼‰ï¼Œæƒ©ç½šå¤§é¢ç§¯è¦†ç›–ï¼ˆä½ zoom + å¤§ç¬”ï¼‰ã€‚**

### 6.3 æµ®ç‚¹å¢¨æ°´ç´¯åŠ å™¨

DrawingEngine ä¸­ä½¿ç”¨ `inkAccumulator` æµ®ç‚¹æ•°ç´¯åŠ åˆ†æ•°å¢¨æ°´æ¶ˆè€—ï¼š

```
æ¯ä¸ª moveStroke() â†’ segmentCost ç´¯åŠ åˆ° inkAccumulator
å½“ inkAccumulator >= 1 â†’ æ‰£å‡ floor(accumulator) æ•´æ•°éƒ¨åˆ†
endStroke() â†’ æ‰£å‡å‰©ä½™åˆ†æ•°éƒ¨åˆ†ï¼ˆä¸å››èˆäº”å…¥ï¼Œä¿æŒç²¾ç¡®å…¬å¹³ï¼‰
```

### 6.4 å¢¨æ°´æŒä¹…åŒ–ä¸ç¦»çº¿æ¢å¤

å¢¨æ°´çŠ¶æ€å­˜å‚¨åœ¨ `localStorage`ï¼ŒåŒ…å«å½“å‰å€¼å’Œæ—¶é—´æˆ³ã€‚é¡µé¢é‡æ–°åŠ è½½æ—¶ï¼š

```
æ¢å¤å¢¨æ°´ = savedInk + floor(elapsed / REGEN_INTERVAL) * REGEN_AMOUNT
```

å³ä½¿ç¦»çº¿æˆ–å…³é—­æµè§ˆå™¨ï¼Œå¢¨æ°´ä¹Ÿä¼šæŒ‰æ—¶é—´è®¡ç®—æ¢å¤ã€‚

---

## ä¸ƒã€å›¾é’‰ç³»ç»Ÿè®¾è®¡

### 7.1 æ¦‚è¿°

ç”¨æˆ·å¯ä»¥åœ¨åœ°å›¾ä¸Šæ”¾ç½®å½©è‰²å›¾é’‰ï¼Œé™„å¸¦ä¸€æ¡ 50 å­—ä»¥å†…çš„çŸ­æ¶ˆæ¯ã€‚

### 7.2 äº¤äº’æµç¨‹

1. ç”¨æˆ·ç‚¹å‡»å·¥å…·æ çš„å›¾é’‰æŒ‰é’® â†’ è¿›å…¥æ”¾ç½®æ¨¡å¼
2. åœ°å›¾é¼ æ ‡æŒ‡é’ˆå˜ä¸ºå¯¹åº”é¢œè‰²çš„å›¾é’‰ SVG å…‰æ ‡
3. ç‚¹å‡»åœ°å›¾æŸå¤„ â†’ å¼¹å‡º `PinPlacer` é¢æ¿ï¼ˆè¾“å…¥æ¶ˆæ¯ + é€‰æ‹©é¢œè‰²ï¼‰
4. ç¡®è®¤ â†’ æ‰£å‡ 50 å¢¨æ°´ â†’ `POST /api/pins` â†’ D1 å†™å…¥
5. æ–°å›¾é’‰ç«‹å³æ˜¾ç¤ºåœ¨åœ°å›¾ä¸Š

### 7.3 å›¾é’‰æ¸²æŸ“

å›¾é’‰ä½¿ç”¨ MapLibre GL çš„ `Marker` API æ¸²æŸ“ï¼Œæ¯ä¸ªå›¾é’‰åŒ…å«ï¼š
- **æ°”æ³¡ tooltip**ï¼šé»˜è®¤æ˜¾ç¤ºå‰ 10 å­—é¢„è§ˆï¼Œhover æ—¶å±•å¼€å®Œæ•´æ¶ˆæ¯ + ä½œè€… + æ—¶é—´
- **å›¾é’‰å›¾æ ‡**ï¼šCSS æ—‹è½¬ 45 åº¦çš„åœ†è§’çŸ©å½¢ï¼Œé¢œè‰²å¯é€‰
- ä»…åœ¨ zoom >= 20 æ—¶åŠ è½½å’Œæ˜¾ç¤º

### 7.4 å›¾é’‰æ•°æ®å­˜å‚¨

```sql
CREATE TABLE map_pins (
  id TEXT PRIMARY KEY,
  user_id TEXT NOT NULL REFERENCES users(id),
  user_name TEXT NOT NULL DEFAULT 'Anonymous',
  lng REAL NOT NULL, lat REAL NOT NULL,
  message TEXT NOT NULL DEFAULT '',
  color TEXT NOT NULL DEFAULT '#E63946',
  created_at INTEGER NOT NULL DEFAULT (unixepoch())
);
```

---

## å…«ã€è®¤è¯ç³»ç»Ÿ

### 8.1 æ¦‚è¿°

ä½¿ç”¨ Lucia Auth v3 + D1Adapterï¼Œå¯†ç å“ˆå¸Œä½¿ç”¨ PBKDF2ï¼ˆWeb Crypto APIï¼‰ã€‚

**ä¸ºä»€ä¹ˆä¸ç”¨ Argon2ï¼Ÿ** Edge Runtime / Cloudflare Workers ä¸æ”¯æŒ `@node-rs/argon2`ï¼ˆéœ€è¦ WASM/native bindingï¼‰ï¼Œå› æ­¤ç»Ÿä¸€ä½¿ç”¨ PBKDF2ï¼Œ600,000 æ¬¡è¿­ä»£ï¼Œç¬¦åˆ OWASP 2024 æ¨èã€‚

### 8.2 è®¤è¯æµç¨‹

```
æ³¨å†Œ: /register â†’ Server Action â†’
  1. éªŒè¯è¾“å…¥ (é‚®ç®±/ç”¨æˆ·å/å¯†ç é•¿åº¦)
  2. æ£€æŸ¥é‚®ç®± + ç”¨æˆ·åå”¯ä¸€æ€§ (D1)
  3. PBKDF2 å“ˆå¸Œå¯†ç  (600K è¿­ä»£)
  4. INSERT users (D1)
  5. lucia.createSession() â†’ Set-Cookie â†’ redirect /canvas

ç™»å½•: /login â†’ Server Action â†’
  1. D1 æŸ¥è¯¢ç”¨æˆ·
  2. PBKDF2 éªŒè¯å¯†ç  (æ—¶åºå®‰å…¨æ¯”è¾ƒ)
  3. lucia.createSession() â†’ Set-Cookie â†’ redirect /canvas

ç”»å¸ƒè®¿é—®: /canvas (æ— éœ€ç™»å½•å¯æµè§ˆ)
  â†’ å°è¯•ç»˜ç”»æ—¶å¼¹å‡º AuthDialog
  â†’ POST /api/drawings æ—¶ validateSession() éªŒè¯

ç™»å‡º: POST /logout â†’
  lucia.invalidateSession() â†’ æ¸…é™¤ Cookie â†’ redirect /login
```

### 8.3 Guest æ¨¡å¼

ç”»å¸ƒé¡µé¢ (`/canvas`) **ä¸éœ€è¦è®¤è¯**å³å¯è®¿é—®ã€‚Guest ç”¨æˆ·å¯ä»¥ï¼š
- æµè§ˆåœ°å›¾
- æŸ¥çœ‹æ‰€æœ‰ç¬”ç”»å’Œå›¾é’‰
- ä¸èƒ½ç»˜ç”»ï¼ˆç‚¹å‡»ç”»ç¬”æ—¶å¼¹å‡ºç™»å½•å¼¹çª—ï¼‰
- ä¸èƒ½æ”¾ç½®å›¾é’‰

---

## ä¹ã€å®æ—¶åŒæ­¥ç³»ç»Ÿ

### 9.1 æ¶æ„

```
SyncManager
  â”œâ”€ DurableObjectClient (WebSocket)  â† å®æ—¶å¹¿æ’­
  â”œâ”€ REST API (POST /api/drawings)    â† ä¸»æŒä¹…åŒ–é€šé“
  â””â”€ OfflineQueue (IndexedDB)         â† ç¦»çº¿ç¼“å†²
```

### 9.2 åŒæ­¥æµç¨‹

```
æ–°ç¬”ç”»å®Œæˆ:
  1. POST /api/drawings â†’ D1 æŒä¹…åŒ– (æ°¸è¿œæ‰§è¡Œ)
  2. DurableObjectClient.send() â†’ WebSocket å¹¿æ’­ç»™æˆ¿é—´å†…å…¶ä»–äºº
  3. è‹¥ç¦»çº¿ â†’ OfflineQueue.enqueue() â†’ é‡è¿åè‡ªåŠ¨ flush

æ”¶åˆ°è¿œç¨‹ç¬”ç”»:
  DurableObjectClient.onMessage() â†’ engine.addExternalStroke()
  â†’ StrokeManager.add() â†’ RenderPipeline.requestRender()
```

### 9.3 æˆ¿é—´åˆ’åˆ†

æŒ‰ zoom-14 ç“¦ç‰‡ key åˆ†æˆ¿é—´ï¼ˆå¦‚ `14/13358/6182`ï¼‰ã€‚è§†å£ä¸­å¿ƒç§»åŠ¨åˆ°æ–°ç“¦ç‰‡æ—¶è‡ªåŠ¨åˆ‡æ¢æˆ¿é—´ã€‚

### 9.4 Durable Object: DrawingRoom

| ç‰¹æ€§ | å®ç° |
|------|------|
| æœ€å¤§è¿æ¥æ•° | 500 / æˆ¿é—´ |
| é€Ÿç‡é™åˆ¶ | 60 msg/s / ç”¨æˆ· |
| å¿ƒè·³ | 30s é—´éš” |
| ç©ºé—²é©±é€ | 5min æ— æ´»åŠ¨æ–­å¼€ |
| è®¤è¯ | D1 æŸ¥è¯¢ Session è¡¨ |
| æŒä¹…åŒ– | DO â†’ Queue â†’ BatchWriter â†’ D1 |

### 9.5 Queue Consumer: BatchWriter

Cloudflare Queue é…ç½®ä¸º `max_batch_size=100, max_batch_timeout=5s`ã€‚BatchWriter æ¥æ”¶ç¬”ç”»äº‹ä»¶åä½¿ç”¨ `D1.batch()` æ‰¹é‡ INSERTï¼ˆ`INSERT OR IGNORE` é˜²æ­¢é‡å¤ï¼‰ã€‚

### 9.6 ç¦»çº¿æ”¯æŒ

```
åœ¨çº¿ â†’ WebSocket å¹¿æ’­ + REST æŒä¹…åŒ–
ç¦»çº¿ â†’ IndexedDB é˜Ÿåˆ— (idb-keyval)
é‡è¿ â†’ drain é˜Ÿåˆ— â†’ æŒ‰æ—¶é—´æˆ³æ’åº â†’ æ‰¹é‡å‘é€
```

---

## åã€æ•°æ®åº“è®¾è®¡ (D1 / SQLite)

### 10.1 è¡¨ç»“æ„

**users è¡¨**

| åˆ— | ç±»å‹ | è¯´æ˜ |
|----|------|------|
| id | TEXT PK | Lucia ç”Ÿæˆ (15å­—ç¬¦) |
| email | TEXT UNIQUE | é‚®ç®± |
| user_name | TEXT UNIQUE | ç”¨æˆ·å |
| password_hash | TEXT | PBKDF2 æ ¼å¼: `pbkdf2:iterations:salt:hash` |
| avatar_url | TEXT | R2 å¤´åƒ URL |
| created_at | INTEGER | Unix ç§’ |

**sessions è¡¨**

| åˆ— | ç±»å‹ | è¯´æ˜ |
|----|------|------|
| id | TEXT PK | Lucia Session ID |
| user_id | TEXT FK â†’ users | ç”¨æˆ· ID |
| expires_at | INTEGER | è¿‡æœŸæ—¶é—´ (Unix ç§’) |

**drawings è¡¨**

| åˆ— | ç±»å‹ | è¯´æ˜ |
|----|------|------|
| id | TEXT PK | UUID v7 |
| user_id | TEXT FK â†’ users | ä½œè€… |
| user_name | TEXT | ä½œè€…å (å†—ä½™ï¼Œå‡å°‘ JOIN) |
| brush_id | TEXT | pencil/marker/spray/highlighter |
| color | TEXT | #RRGGBB |
| opacity | REAL | [0, 1] |
| size | REAL | åŸºå‡† CSS px |
| points | TEXT (JSON) | StrokePoint[] æ•°ç»„ |
| min_lat/max_lat/min_lng/max_lng | REAL | ç©ºé—´åŒ…å›´ç›’ |
| center_lat/center_lng | REAL | ä¸­å¿ƒç‚¹ |
| created_zoom | INTEGER | åˆ›å»ºæ—¶ç¼©æ”¾çº§åˆ« |
| meta | TEXT (JSON) | æ‰©å±•å…ƒæ•°æ® |
| created_at | INTEGER | Unix ç§’ |

**ç´¢å¼•ï¼š**
- `idx_drawings_bounds(min_lng, max_lng, min_lat, max_lat)` â€” ç©ºé—´æŸ¥è¯¢
- `idx_drawings_user(user_id)` â€” ç”¨æˆ·æŸ¥è¯¢
- `idx_drawings_created(created_at DESC)` â€” æ—¶é—´æ’åº

**map_pins è¡¨**

| åˆ— | ç±»å‹ | è¯´æ˜ |
|----|------|------|
| id | TEXT PK | UUID v7 |
| user_id | TEXT FK â†’ users | ä½œè€… |
| user_name | TEXT | ä½œè€…å |
| lng/lat | REAL | ç»çº¬åº¦ |
| message | TEXT | ç•™è¨€ (<=50å­—) |
| color | TEXT | å›¾é’‰é¢œè‰² |
| created_at | INTEGER | Unix ç§’ |

### 10.2 ç©ºé—´æŸ¥è¯¢

D1 (SQLite) æ²¡æœ‰ PostGISï¼Œä½¿ç”¨**åŒ…å›´ç›’ç²—è¿‡æ»¤**ï¼š

```sql
SELECT * FROM drawings
WHERE min_lng <= ?maxLng AND max_lng >= ?minLng
  AND min_lat <= ?maxLat AND max_lat >= ?minLat
ORDER BY created_at DESC LIMIT 5000
```

ç²¾ç¡®çš„ç©ºé—´ç´¢å¼•åœ¨å®¢æˆ·ç«¯ä½¿ç”¨ `rbush` (R-tree) å®Œæˆã€‚

---

## åä¸€ã€Cloudflare èµ„æºä¸éƒ¨ç½²æ¶æ„

### 11.1 èµ„æºæ¸…å•

| èµ„æº | Binding | ç”¨é€” |
|------|---------|------|
| **Cloudflare Pages** | â€” | æ‰˜ç®¡ Next.js SSR/SSG |
| **D1** | `DB` | ç”¨æˆ·/ä¼šè¯/ç¬”ç”»/å›¾é’‰ |
| **R2** | `BUCKET` | å¤´åƒå­˜å‚¨ |
| **KV** | `CACHE` | è¾¹ç¼˜ç¼“å­˜ (é¢„ç•™) |
| **Durable Objects** | `DRAWING_ROOM` | WebSocket å®æ—¶æˆ¿é—´ |
| **Queues** | `STROKE_QUEUE` | å¼‚æ­¥ç¬”ç”»æ‰¹é‡å†™å…¥ |

### 11.2 ä¸¤ä¸ª wrangler.toml

| é¡¹ç›® | æ–‡ä»¶ | è¯´æ˜ |
|------|------|------|
| Next.js ä¸»é¡¹ç›® | `./wrangler.toml` | Pages ç»‘å®š: D1, R2, KV |
| cf-workers | `./cf-workers/wrangler.toml` | Worker ç»‘å®š: DO, D1, R2, Queue |

### 11.3 éƒ¨ç½²æµç¨‹

```bash
# 1. åˆ›å»º Cloudflare èµ„æº
npx wrangler d1 create map-db
npx wrangler r2 bucket create map-storage
npx wrangler kv namespace create CACHE

# 2. æ›¿æ¢ wrangler.toml ä¸­çš„ placeholder ID (ä¸¤ä¸ªéƒ½è¦)

# 3. æ‰§è¡Œæ•°æ®åº“è¿ç§»
npx wrangler d1 execute map-db --file=drizzle/migrations/0001_init.sql
npx wrangler d1 execute map-db --file=drizzle/migrations/0002_map_pins.sql

# 4. è®¾ç½® secrets
npx wrangler secret put AUTH_SECRET
cd cf-workers && npx wrangler secret put AUTH_SECRET

# 5. éƒ¨ç½²
pnpm deploy              # æ„å»º + éƒ¨ç½² Pages
pnpm deploy:workers      # éƒ¨ç½² cf-workers (DO + Queue)
```

---

## åäºŒã€æˆæœ¬ä¼°ç®—

### å…è´¹é¢åº¦ (Cloudflare Free Plan)

| ç»„ä»¶ | å…è´¹é¢åº¦ | é¢„ä¼°åˆæœŸç”¨é‡ | å¤Ÿç”¨ |
|------|---------|-------------|------|
| Pages | 500 æ„å»º/æœˆï¼Œæ— é™å¸¦å®½ | ~30 æ„å»º/æœˆ | Yes |
| D1 | 5M è¯»/å¤©ï¼Œ100K å†™/å¤©ï¼Œ5GB | ~100K è¯»/å¤©ï¼Œ10K å†™/å¤© | Yes |
| R2 | 10GBï¼Œ1M è¯·æ±‚/æœˆ | ~1GBï¼Œ100K è¯·æ±‚/æœˆ | Yes |
| DO | 100K è¯·æ±‚/å¤© | ~50K è¯·æ±‚/å¤© | Yes |
| Queue | 10K æ“ä½œ/å¤© | ~5K æ“ä½œ/å¤© | Yes |

**ç»“è®ºï¼šåˆæœŸå®Œå…¨å…è´¹ã€‚** è¶…å‡ºå Workers Paid Plan $5/æœˆèµ·ã€‚

---

## åä¸‰ã€UI/UX è®¾è®¡è¦ç‚¹

### 13.1 å·¥å…·æ 

æ°´å¹³é¡¶éƒ¨å±…ä¸­å·¥å…·æ ï¼ŒåŒ…å«ï¼š
- æ‰‹å½¢ï¼ˆæµè§ˆæ¨¡å¼ï¼‰/ ç”»ç¬”ï¼ˆç»˜ç”»æ¨¡å¼ï¼‰/ å›¾é’‰ï¼ˆæ”¾ç½®æ¨¡å¼ï¼‰åˆ‡æ¢
- ç¬”åˆ·é¢æ¿ï¼ˆPopoverï¼šç±»å‹ç½‘æ ¼ + å¤§å°/é€æ˜åº¦ Sliderï¼‰
- é¢œè‰²é€‰æ‹©å™¨ï¼ˆPopoverï¼š54 è‰²ç½‘æ ¼ + è‡ªå®šä¹‰ Hex/Color Inputï¼‰
- æ’¤é”€ / é‡åš
- å¢¨æ°´æ¡ï¼ˆæ¸å˜è‰² + `ink.toFixed(2)` æ•°å€¼æ˜¾ç¤ºï¼‰

### 13.2 åœ°å›¾æ§ä»¶

- **å·¦ä¸Šè§’**ï¼šç¼©æ”¾çº§åˆ« + é¼ æ ‡åæ ‡é¢æ¿
- **å·¦ä¸Šè§’ (offset 48px)**ï¼šMapLibre NavigationControlï¼ˆç¼©æ”¾ + çº¢ç™½ç½—ç›˜ï¼‰
- **æ¯›ç»ç’ƒé£æ ¼**ï¼šæ‰€æœ‰æ§ä»¶ä½¿ç”¨ `backdrop-filter: blur(12px)` + åŠé€æ˜èƒŒæ™¯
- **è‡ªå®šä¹‰ç½—ç›˜**ï¼šSVG çº¢/ç™½æŒ‡åŒ—é’ˆå›¾æ ‡

### 13.3 æç¤ºç³»ç»Ÿ

| åœºæ™¯ | UI æç¤º |
|------|---------|
| ç¼©æ”¾ä¸è¶³ï¼ˆç”»ç¬”ï¼‰| é»„è‰²æµ®åŠ¨æ¡ï¼šè¯·æ”¾å¤§åˆ° 18 çº§ä»¥ä¸Šæ‰èƒ½ç»˜ç”» |
| ç¼©æ”¾ä¸è¶³ï¼ˆå›¾é’‰ï¼‰| é»„è‰²æµ®åŠ¨æ¡ï¼šè¯·æ”¾å¤§åˆ° 20 çº§ä»¥ä¸Šæ‰èƒ½æ”¾ç½®å›¾é’‰ |
| å¢¨æ°´è€—å°½ | çº¢è‰²æµ®åŠ¨æ¡ï¼šå¢¨æ°´è€—å°½ï¼Œè¯·ç¨ç­‰ç‰‡åˆ» (3s è‡ªåŠ¨æ¶ˆå¤±) |
| å›¾é’‰æ”¾ç½®ä¸­ | è“è‰²æµ®åŠ¨æ¡ï¼šç‚¹å‡»åœ°å›¾é€‰æ‹©å›¾é’‰ä½ç½® |

### 13.4 Tooltip æ ·å¼

ç™½è‰²èƒŒæ™¯ + åº•éƒ¨ä¸‰è§’ç®­å¤´ + é˜´å½±ï¼Œhover æ—¶å±•å¼€å®Œæ•´å†…å®¹å¹¶æ”¾å¤§ 1.08 å€ã€‚

---

## åå››ã€Landing Page

é¦–é¡µ (`/`) ä¸ºä¸­è‹±åŒè¯­ Landing Pageï¼š

- é¡¶éƒ¨æµ®åŠ¨æ¯›ç»ç’ƒå¯¼èˆªæ  + è¯­è¨€åˆ‡æ¢æŒ‰é’®
- Hero åŒºåŸŸï¼šæ ‡é¢˜ + æè¿° + CTA æŒ‰é’® â†’ `/canvas`
- åŠŸèƒ½ä»‹ç»ï¼šåœ°å›¾æ¶‚é¸¦ / å®šä½ç•™è¨€ / å…±åŒåˆ›ä½œ
- ä½¿ç”¨æŒ‡å—ï¼šä¸‰æ­¥ä¸Šæ‰‹
- å¢¨æ°´ç³»ç»Ÿè¯´æ˜
- æ„¿æ™¯åŒºåŸŸ + Footer

---

## åäº”ã€å…³é”®å¸¸é‡é…ç½®

| å¸¸é‡ | å€¼ | æ–‡ä»¶ | è¯´æ˜ |
|------|------|------|------|
| `MIN_DRAW_ZOOM` | 18 | constants.ts | æœ€ä½ç»˜ç”»ç¼©æ”¾ |
| `MIN_PIN_ZOOM` | 20 | constants.ts | æœ€ä½å›¾é’‰ç¼©æ”¾ |
| `PIN_INK_COST` | 50 | constants.ts | å›¾é’‰å¢¨æ°´æ¶ˆè€— |
| `PIN_MAX_MESSAGE_LENGTH` | 50 | constants.ts | å›¾é’‰æ¶ˆæ¯é•¿åº¦é™åˆ¶ |
| `MAX_BRUSH_SIZE` | 10 | constants.ts | æœ€å¤§ç”»ç¬”å¤§å° |
| `STROKE_HIDE_ZOOM_DIFF` | 3 | constants.ts | ç¼©æ”¾éšè—é˜ˆå€¼ |
| `MAX_INK` | 100 | InkManager.ts | æœ€å¤§å¢¨æ°´å€¼ |
| `REGEN_INTERVAL_MS` | 18000 | InkManager.ts | æ¢å¤é—´éš” (ms) |
| `INK_COST_K` | 20 | InkManager.ts | å¹³è¡¡å¸¸æ•° |
| `MAX_UNDO_STACK` | 100 | constants.ts | æ’¤é”€æ ˆå¤§å° |
| `MAX_CONNECTIONS` | 500 | DrawingRoom.ts | æ¯æˆ¿é—´æœ€å¤§ WS è¿æ¥ |
| `RATE_LIMIT_MAX` | 60 | DrawingRoom.ts | æ¯ç§’æœ€å¤§æ¶ˆæ¯æ•° |
| `HEARTBEAT_INTERVAL` | 30000 | DrawingRoom.ts | å¿ƒè·³é—´éš” (ms) |
| `IDLE_TIMEOUT` | 300000 | DrawingRoom.ts | ç©ºé—²é©±é€æ—¶é—´ (ms) |
| `COLOR_PRESETS` | 54 è‰² | constants.ts | é¢„è®¾é¢œè‰² (9è¡Œx6åˆ—) |
| `PIN_COLORS` | 10 è‰² | constants.ts | å›¾é’‰é¢„è®¾é¢œè‰² |

---

## åå…­ã€æœªæ¥æ‰©å±•è®¡åˆ’

### å·²é¢„ç•™ä½†å°šæœªå¯ç”¨

- **TileCache** â€” ä½å›¾ç“¦ç‰‡ç¼“å­˜ï¼ˆRenderPipeline ä¸­å·²å®ä¾‹åŒ–ï¼Œæ¸²æŸ“æ—¶å°šæœªä½¿ç”¨ï¼‰
- **KV ç¼“å­˜** â€” wrangler.toml å·²å£°æ˜ CACHE ç»‘å®šï¼Œå¯ç”¨äºçƒ­ç‚¹æ•°æ®ç¼“å­˜
- **Web Workers** â€” OffscreenCanvas ç¦»å±æ¸²æŸ“ï¼ˆè¿›ä¸€æ­¥ä¼˜åŒ–æ€§èƒ½ï¼‰

### è§„æ¨¡åŒ–æ–¹å‘

- **è§’è‰²åˆ†ç¦»**ï¼šç”»æ‰‹ WebSocket (<=500) + è§‚å¯Ÿè€… CDN å¿«ç…§ï¼ˆæ— ä¸Šé™ï¼‰
- **DO æ‰‡å‡ºæ ‘**ï¼šSource DO â†’ Relay DO â†’ å®¢æˆ·ç«¯ï¼Œçªç ´å• DO è¿æ¥æ•°é™åˆ¶
- **D1 å†·å½’æ¡£**ï¼š6 ä¸ªæœˆä»¥ä¸Šå†å²ç¬”ç”»å½’æ¡£åˆ° R2 (JSON/Parquet)
- **LOD æ¸²æŸ“**ï¼šä½ç¼©æ”¾çº§åˆ«ä½¿ç”¨ Douglas-Peucker ç®€åŒ–ç¬”ç”»ç‚¹æ•°

### å®¢æˆ·ç«¯æ–¹å‘

- **PWA**ï¼šService Worker + manifest.json
- **Capacitor**ï¼š`next export` â†’ iOS/Android æ‰“åŒ…
